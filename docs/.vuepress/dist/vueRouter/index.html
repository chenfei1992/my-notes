<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ğŸ Introduction | ç¬”è®°</title>
    <meta name="generator" content="VuePress 1.5.3">
    
    <meta name="description" content="Just playing around">
    <link rel="preload" href="/assets/css/0.styles.ae3ca5a1.css" as="style"><link rel="preload" href="/assets/js/app.1dd2d079.js" as="script"><link rel="preload" href="/assets/js/2.5b5e09f6.js" as="script"><link rel="preload" href="/assets/js/28.cf7f39de.js" as="script"><link rel="prefetch" href="/assets/js/10.a33833d2.js"><link rel="prefetch" href="/assets/js/11.cc109dba.js"><link rel="prefetch" href="/assets/js/12.4ec8bf0b.js"><link rel="prefetch" href="/assets/js/13.c4b52ead.js"><link rel="prefetch" href="/assets/js/14.7b14fb4a.js"><link rel="prefetch" href="/assets/js/15.2145b756.js"><link rel="prefetch" href="/assets/js/16.dcd4bf90.js"><link rel="prefetch" href="/assets/js/17.941e4207.js"><link rel="prefetch" href="/assets/js/18.7b96dcc6.js"><link rel="prefetch" href="/assets/js/19.b0ee4e95.js"><link rel="prefetch" href="/assets/js/20.04d41889.js"><link rel="prefetch" href="/assets/js/21.da8ba1f1.js"><link rel="prefetch" href="/assets/js/22.a4be886a.js"><link rel="prefetch" href="/assets/js/23.1b554486.js"><link rel="prefetch" href="/assets/js/24.46bb4888.js"><link rel="prefetch" href="/assets/js/25.6a64171b.js"><link rel="prefetch" href="/assets/js/26.76c13837.js"><link rel="prefetch" href="/assets/js/27.342ea004.js"><link rel="prefetch" href="/assets/js/29.089a992e.js"><link rel="prefetch" href="/assets/js/3.9d429554.js"><link rel="prefetch" href="/assets/js/30.80f23c0e.js"><link rel="prefetch" href="/assets/js/31.2dbac603.js"><link rel="prefetch" href="/assets/js/4.a4ca32bb.js"><link rel="prefetch" href="/assets/js/5.bf645d3b.js"><link rel="prefetch" href="/assets/js/6.737b8a35.js"><link rel="prefetch" href="/assets/js/7.b3bd3833.js"><link rel="prefetch" href="/assets/js/8.7ce880e2.js"><link rel="prefetch" href="/assets/js/9.58972119.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ae3ca5a1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">ç¬”è®°</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/demoPages/" class="nav-link">
  Demo
</a></div><div class="nav-item"><a href="/tools/" class="nav-link">
  å·¥å…·åº“
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/demoPages/" class="nav-link">
  Demo
</a></div><div class="nav-item"><a href="/tools/" class="nav-link">
  å·¥å…·åº“
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">éšå½•</a></li><li><a href="/VirtualDom/" class="sidebar-link">è™šæ‹ŸDOM</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>VUE</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue/" class="sidebar-link">vue åŸç†åˆ†æ</a></li><li><a href="/vueRouter/" aria-current="page" class="active sidebar-link">vueRouter</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vueRouter/#introduction" class="sidebar-link">ğŸ Introduction</a></li><li class="sidebar-sub-header"><a href="/vueRouter/#è·¯ç”±æ³¨å†Œ" class="sidebar-link">ğŸ è·¯ç”±æ³¨å†Œ</a></li><li class="sidebar-sub-header"><a href="/vueRouter/#vuerouterå¯¹è±¡" class="sidebar-link">VueRouterå¯¹è±¡</a></li><li class="sidebar-sub-header"><a href="/vueRouter/#matcher" class="sidebar-link">matcher</a></li></ul></li><li><a href="/mustKnow/" class="sidebar-link">vue å¼€å‘å¿…çŸ¥</a></li><li><a href="/vueInterview/" class="sidebar-link">vue é¢è¯•é¢˜</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å°ç¨‹åº</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>REACT</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>æ¡£æ¡ˆ</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/packages/" class="sidebar-link">åŸç”Ÿå°è£…</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>åŸç†åˆ†æ</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/h5Development/" class="sidebar-link">H5 å¼€å‘æŠ€å·§</a></li><li><a href="/cssModule/" class="sidebar-link">CSS æ–‡æ¡£</a></li><li><a href="/javascript/" class="sidebar-link">javascript</a></li><li><a href="/typeScript/" class="sidebar-link">typeScript</a></li><li><a href="/ASM/" class="sidebar-link">ASM.js</a></li><li><a href="/%E9%9D%A2%E8%AF%95/" class="sidebar-link">é¢è¯•</a></li><li><a href="/indexedDB/" class="sidebar-link">indexedDB</a></li><li><a href="/toolFunction/" class="sidebar-link">toolFunction</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>æ„å»ºå·¥å…·</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/http/" class="sidebar-link">HTTP</a></li><li><a href="/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="sidebar-link">æ€§èƒ½ä¼˜åŒ–</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="introduction">ğŸ Introduction</h2> <p>Vue-Routeræ”¯æŒ<code>hash</code>,<code>history</code>,<code>abstract</code>3ç§è·¯ç”±ï¼Œæä¾›å¹³<code>&lt;router-link&gt;</code>å’Œ<code>&lt;router-view&gt;</code>2ç§ç»„ä»¶ï¼Œè¿˜æä¾›äº†ç®€å•çš„è·¯ç”±é…ç½®å’Œä¸€ç³»åˆ—å¥½ç”¨çš„API</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token number">1.</span>å®šä¹‰ï¼ˆè·¯ç”±ï¼‰ç»„ä»¶
<span class="token comment">// å¯ä»¥ä»å…¶ä»–æ–‡ä»¶ import è¿›æ¥</span>
<span class="token number">2.</span>å®šä¹‰è·¯ç”±
<span class="token comment">// æ¯ä¸ªè·¯ç”±åº”è¯¥æ˜ å°„ä¸€ä¸ªç»„ä»¶ã€‚å…¶ä¸­`component`å¯ä»¥æ˜¯</span>
<span class="token comment">// é€šè¿‡Vue.extend()åˆ›å»ºçš„ç»„ä»¶æ„é€ å™¨</span>
<span class="token comment">// æˆ–è€…ï¼Œåªæ˜¯ä¸€ä¸ªç»„ä»¶é…ç½®å¯¹è±¡</span>
<span class="token number">3.</span>åˆ›å»ºrouterå®ä¾‹ï¼Œç„¶åä¼ <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">router</span><span class="token template-punctuation string">`</span></span>é…ç½®
<span class="token number">4.</span>åˆ›å»ºå’ŒæŒ‚è½½æ ¹å®ä¾‹
<span class="token comment">// è®°å¾—è¦é€šè¿‡routeré…ç½®å‚æ•°æ³¨å…¥è·¯ç”±</span>
<span class="token comment">// ä»è€Œè®©æ•´ä¸ªåº”ç”¨éƒ½æœ‰è·¯ç”±åŠŸèƒ½</span>
</code></pre></div><h2 id="è·¯ç”±æ³¨å†Œ">ğŸ è·¯ç”±æ³¨å†Œ</h2> <h3 id="vue-use">Vue.use</h3> <p>Vueæä¾›äº†<code>Vue.use</code>çš„å…¨å±€APIæ¥æ³¨å†Œè¿™äº›æ’ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹å®ƒçš„å®ç°åŸç†ï¼Œå®šä¹‰åœ¨<code>vue/src/core/global-api/use.js</code>ä¸­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initUse</span><span class="token punctuation">(</span><span class="token parameter">Vue<span class="token operator">:</span> GlobalApi</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Vue<span class="token punctuation">.</span><span class="token function-variable function">use</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">plugin<span class="token operator">:</span> Function<span class="token operator">|</span>Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> installedPlugins <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_installedPlugins <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_installedPlugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>installedPlugins<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">toArray</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    args<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin<span class="token punctuation">.</span>install <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      plugin<span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>plugin<span class="token punctuation">,</span>args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    installedPlugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Vue.use</code>æ¥å—ä¸€ä¸ª<code>plugin</code>å‚æ•°ï¼Œå¹¶ä¸”ç»´æŠ¤äº†ä¸€ä¸ª<code>_installedPlugins</code>æ•°ç»„ï¼Œå®ƒå­˜å‚¨æ‰€æœ‰æ³¨å†Œè¿‡çš„<code>plugin</code>ï¼›æ¥ç€åˆä¼šåˆ¤æ–­<code>plugin</code>æœ‰æ²¡æœ‰å®šä¹‰<code>install</code>æ–¹æ³•ï¼Œå¦‚æœæœ‰çš„è¯åˆ™è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå¹¶ä¸”è¯¥æ–¹æ³•æ‰§è¡Œçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯<code>Vue</code>ï¼›æœ€åæŠŠ<code>plugin</code>å­˜å‚¨åˆ°<code>installedPlugins</code>ä¸­
å¯ä»¥çœ‹åˆ°Vueæä¾›çš„æ’ä»¶æ³¨å†Œæœºåˆ¶å¾ˆç®€å•ï¼Œæ¯ä¸ªæ’ä»¶éƒ½éœ€è¦å®ç°ä¸€ä¸ªé™æ€çš„<code>install</code>æ–¹æ³•ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œ<code>Vue.use</code>æ³¨å†Œæ’ä»¶çš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡Œè¿™ä¸ª<code>install</code>æ–¹æ³•ï¼Œå¹¶ä¸”åœ¨è¿™ä¸ª<code>install</code>æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æˆ‘ä»¬å¯ä»¥æ‹¿åˆ°<code>Vue</code>å¯¹è±¡ï¼Œè¿™æ ·çš„å¥½å¤„å°±æ˜¯ä½œä¸ºæ’ä»¶çš„ç¼–å†™æ–¹ä¸éœ€è¦å†é¢å¤–å»<code>import Vue</code>äº†ã€‚</p> <h3 id="è·¯ç”±å®‰è£…">è·¯ç”±å®‰è£…</h3> <p>Vue-Routerçš„å…¥å£æ–‡ä»¶æ˜¯<code>src/index.js</code>ï¼Œå…¶ä¸­å®šä¹‰äº†<code>VueRouter</code>ç±»ï¼Œä¹Ÿå®ç°äº†<code>install</code>çš„é™æ€æ–¹æ³•ï¼š<code>VueRouter.install = install</code>,å®ƒçš„å®šä¹‰åœ¨<code>src/install.js</code>ä¸­</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">let</span> _Vue
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">install</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>install<span class="token punctuation">.</span>installed <span class="token operator">&amp;&amp;</span> _Vue <span class="token operator">===</span> Vue<span class="token punctuation">)</span> <span class="token keyword">return</span>
  install<span class="token punctuation">.</span>installed <span class="token operator">=</span> <span class="token boolean">true</span>
  _Vue <span class="token operator">=</span> Vue
  <span class="token keyword">const</span> <span class="token function-variable function">isDef</span> <span class="token operator">=</span> <span class="token parameter">v</span> <span class="token operator">=&gt;</span> v <span class="token operator">!==</span> <span class="token keyword">undefined</span>
  <span class="token keyword">const</span> <span class="token function-variable function">registerInstance</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> callVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_parentVnode
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>registerRouteInstance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">i</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>callVal<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">beforeCreate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot <span class="token operator">=</span> <span class="token keyword">this</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router
        <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        Vue<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token string">'_route'</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span>history<span class="token punctuation">.</span>current<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_rooterRoot <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$parent <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>_routerRoot<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
      <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">destroyed</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span><span class="token string">'$router'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot<span class="token punctuation">.</span>_router
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span><span class="token string">'$route'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot<span class="token punctuation">.</span>_route
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterView'</span><span class="token punctuation">,</span>View<span class="token punctuation">)</span>
  Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterLink'</span><span class="token punctuation">,</span>Link<span class="token punctuation">)</span>
  <span class="token keyword">const</span> strats <span class="token operator">=</span> Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>optionMergeStrategies
  strats<span class="token punctuation">.</span>beforeRouteEnter <span class="token operator">=</span> strats<span class="token punctuation">.</span>beforeRouteLeave <span class="token operator">=</span> strats<span class="token punctuation">.</span>beforeRouteUpdate <span class="token operator">=</span> strats<span class="token punctuation">.</span>created
<span class="token punctuation">}</span>
</code></pre></div><p>å½“ç”¨æˆ·æ‰§è¡Œ<code>Vue.use(VueRouter)</code>çš„æ—¶å€™ï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨æ‰§è¡Œ<code>install</code>å‡½æ•°ï¼Œä¸ºäº†ç¡®ä¿<code>install</code>é€»è¾‘åªæ‰§è¡Œä¸€æ¬¡ï¼Œç”¨äº†<code>install.installed</code>å˜é‡åšå·²å®‰è£…çš„æ ‡å¿—ä½ã€‚å¦å¤–ç”¨ä¸€ä¸ªå…¨å±€çš„<code>_Vue</code>æ¥æ¥æ”¶å‚æ•°<code>Vue</code>ï¼Œå› ä¸ºä½œä¸ºVueçš„æ’ä»¶å¯¹<code>Vue</code>å¯¹è±¡æ˜¯ç”±ä¾èµ–çš„ï¼Œä½†åˆä¸èƒ½å»å•ç‹¬å»<code>import Vue</code>,å› ä¸ºé‚£æ ·ä¼šå¢åŠ åŒ…ä½“ç§¯ï¼Œæ‰€ä»¥å°±é€šè¿‡è¿™ç§æ–¹å¼æ‹¿åˆ°<code>Vue</code>å¯¹è±¡ã€‚
Vue-Routerå®‰è£…æœ€é‡è¦çš„ä¸€æ­¥å°±æ˜¯åˆ©ç”¨<code>Vue.mixin</code>å»æŠŠ<code>beforeCreate</code>å’Œ<code>destroyed</code>é’©å­å‡½æ•°æ³¨å…¥åˆ°æ¯ä¸€ä¸ªç»„ä»¶ä¸­ã€‚<code>Vue.mixin</code>çš„å®šä¹‰ï¼Œåœ¨<code>vue/src/core/global-api/mixin.js</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initMixin</span> <span class="token punctuation">(</span><span class="token parameter">Vue<span class="token operator">:</span> GlobalAPI</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Vue<span class="token punctuation">.</span><span class="token function-variable function">mixin</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">mixin<span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">,</span>mixin<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å®ƒçš„å®ç°å®é™…ä¸Šéå¸¸ç®€å•ï¼Œå°±æ˜¯æŠŠè¦æ··å…¥çš„å¯¹è±¡é€šè¿‡<code>mergeOptions</code>åˆå¹¶åˆ°<code>Vue</code>çš„<code>options</code>ä¸­ï¼Œç”±äºæ¯ä¸ªç»„ä»¶çš„æ„é€ å‡½æ•°éƒ½ä¼šåœ¨<code>extend</code>é˜¶æ®µåˆå¹¶<code>Vue.options</code>åˆ°è‡ªèº«çš„<code>options</code>ä¸­ï¼Œæ‰€ä»¥ä¹Ÿå°±ç›¸å½“äºæ¯ä¸ªç»„ä»¶éƒ½å®šä¹‰äº†<code>mixin</code>å®šä¹‰çš„é€‰é¡¹ã€‚</p> <p>å›åˆ°<code>Vue-Router</code>çš„<code>install</code>æ–¹æ³•ï¼Œå…ˆçœ‹æ··å…¥çš„<code>beforeCreate</code>é’©å­å‡½æ•°ï¼Œå¯¹äºæ ¹<code>Vue</code>å®ä¾‹è€Œè¨€ï¼Œæ‰§è¡Œè¯¥é’©å­å‡½æ•°çš„å®šä¹‰äº†<code>this._routerRoot</code>è¡¨ç¤ºå®ƒè‡ªèº«ï¼›<code>this._router</code>è¡¨ç¤º<code>VueRouter</code>çš„å®ä¾‹<code>router</code>ï¼Œå®ƒæ˜¯åœ¨<code>new Vue</code>çš„æ—¶å€™ä¼ å…¥çš„ï¼›å¦å¤–æ‰§è¡Œäº†<code>this._router.init()</code>æ–¹æ³•åˆå§‹åŒ–<code>router</code>ï¼Œè¿™ä¸ªé€»è¾‘ä¹‹åä»‹ç»ï¼Œç„¶åç”¨<code>defineReactive</code>æ–¹æ³•æŠŠ<code>this._route</code>å˜æˆå“åº”å¼å¯¹è±¡ï¼Œè¿™ä¸ªä½œç”¨æˆ‘ä»¬ä¹‹åä¼šä»‹ç»ã€‚è€Œå¯¹äºå­ç»„ä»¶è€Œè¨€ï¼Œç”±äºç»„ä»¶æ˜¯æ ‘çŠ¶æ€ç»“æ„ï¼Œåœ¨éå†ç»„ä»¶æ ‘çš„è¿‡ç¨‹ä¸­ï¼Œå®ƒä»¬åœ¨æ‰§è¡Œè¯¥é’©å­å‡½æ•°çš„æ—¶å€™<code>this._routerRoot</code>å§‹ç»ˆæŒ‡å‘çš„ç¦»å®ƒæœ€è¿‘çš„ä¼ å…¥äº†<code>router</code>å¯¹è±¡ä½œä¸ºé…ç½®è€Œå®ä¾‹åŒ–çš„çˆ¶å®ä¾‹ã€‚</p> <p>å¯¹äº<code>beforeCreate</code>å’Œ<code>destroyed</code>é’©å­å‡½æ•°ï¼Œå®ƒä»¬éƒ½ä¼šæ‰§è¡Œ<code>registerInstance</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æˆ‘ä»¬ä¹Ÿæ˜¯ä¼šä»‹ç»ã€‚</p> <p>æ¥ç€ç»™ <code>Vue</code> åŸå‹ä¸Šå®šä¹‰äº† <code>$router</code> å’Œ <code>$route 2</code> ä¸ªå±æ€§çš„ get æ–¹æ³•ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨ç»„ä»¶å®ä¾‹ä¸Šå¯ä»¥è®¿é—® <code>this.$router</code> ä»¥åŠ <code>this.$route</code>ï¼Œå®ƒä»¬çš„ä½œç”¨ä¹‹åä»‹ç»ã€‚</p> <p>æ¥ç€åˆé€šè¿‡ <code>Vue.component</code>æ–¹æ³•å®šä¹‰äº†å…¨å±€çš„ <code>&lt;router-link&gt;</code> å’Œ <code>&lt;router-view&gt;</code> 2 ä¸ªç»„ä»¶ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨å†™æ¨¡æ¿çš„æ—¶å€™å¯ä»¥ä½¿ç”¨è¿™ä¸¤ä¸ªæ ‡ç­¾ï¼Œå®ƒä»¬çš„ä½œç”¨ä¹Ÿæ˜¯ä¹‹åä»‹ç»ã€‚</p> <p>æœ€åå®šä¹‰äº†è·¯ç”±ä¸­çš„é’©å­å‡½æ•°çš„åˆå¹¶ç­–ç•¥ï¼Œå’Œæ™®é€šçš„é’©å­å‡½æ•°ä¸€æ ·ã€‚</p> <h2 id="vuerouterå¯¹è±¡">VueRouterå¯¹è±¡</h2> <p>VueRouter çš„å®ç°æ˜¯ä¸€ä¸ªç±»ï¼Œæˆ‘ä»¬å…ˆå¯¹å®ƒåšä¸€ä¸ªç®€å•åœ°åˆ†æï¼Œå®ƒçš„å®šä¹‰åœ¨ src/index.js ä¸­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">VueRouter</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function-variable function">install</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> version<span class="token operator">:</span> string<span class="token punctuation">;</span>

  app<span class="token operator">:</span> any<span class="token punctuation">;</span>
  apps<span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  ready<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
  readyCbs<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  options<span class="token operator">:</span> RouterOptions<span class="token punctuation">;</span>
  mode<span class="token operator">:</span> string<span class="token punctuation">;</span>
  history<span class="token operator">:</span> HashHistory <span class="token operator">|</span> HTML5History <span class="token operator">|</span> AbstractHistory<span class="token punctuation">;</span>
  matcher<span class="token operator">:</span> Matcher<span class="token punctuation">;</span>
  fallback<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
  beforeHooks<span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  resolveHooks<span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  afterHooks<span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>AfterNavigationHook<span class="token operator">&gt;</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token operator">:</span> RouterOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>apps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options
    <span class="token keyword">this</span><span class="token punctuation">.</span>beforeHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resolveHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>afterHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>matcher <span class="token operator">=</span> <span class="token function">createMatcher</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>routes <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>

    <span class="token keyword">let</span> mode <span class="token operator">=</span> options<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token string">'hash'</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fallback <span class="token operator">=</span> mode <span class="token operator">===</span> <span class="token string">'history'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>supportsPushState <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>fallback <span class="token operator">!==</span> <span class="token boolean">false</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mode <span class="token operator">=</span> <span class="token string">'hash'</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mode <span class="token operator">=</span> <span class="token string">'abstract'</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'history'</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HTML5History</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'hash'</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fallback<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'abstract'</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbstractHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">assert</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">invalid mode: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">match</span> <span class="token punctuation">(</span>
    raw<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span>
    current<span class="token operator">?</span><span class="token operator">:</span> Route<span class="token punctuation">,</span>
    redirectedFrom<span class="token operator">?</span><span class="token operator">:</span> Location
  <span class="token punctuation">)</span><span class="token operator">:</span> Route <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>matcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> current<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">currentRoute</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">?</span>Route <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span>current
  <span class="token punctuation">}</span>

  <span class="token function">init</span> <span class="token punctuation">(</span><span class="token parameter">app<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">assert</span><span class="token punctuation">(</span>
      install<span class="token punctuation">.</span>installed<span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">not installed. Make sure to call \`Vue.use(VueRouter)\` </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">before creating root instance.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> app

    <span class="token keyword">const</span> history <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history

    <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HTML5History</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HashHistory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token function-variable function">setupHashListener</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        history<span class="token punctuation">.</span><span class="token function">setupListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>
        history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        setupHashListener<span class="token punctuation">,</span>
        setupHashListener
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        app<span class="token punctuation">.</span>_route <span class="token operator">=</span> route
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">beforeEach</span> <span class="token punctuation">(</span>fn<span class="token operator">:</span> Function<span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">registerHook</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">beforeResolve</span> <span class="token punctuation">(</span>fn<span class="token operator">:</span> Function<span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">registerHook</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolveHooks<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">afterEach</span> <span class="token punctuation">(</span>fn<span class="token operator">:</span> Function<span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">registerHook</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>afterHooks<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">onReady</span> <span class="token punctuation">(</span><span class="token parameter">cb<span class="token operator">:</span> Function<span class="token punctuation">,</span> errorCb<span class="token operator">?</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">onReady</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> errorCb<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">onError</span> <span class="token punctuation">(</span><span class="token parameter">errorCb<span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>errorCb<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">push</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> onComplete<span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">replace</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> onComplete<span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">go</span> <span class="token punctuation">(</span><span class="token parameter">n<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">back</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">forward</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">getMatchedComponents</span> <span class="token punctuation">(</span>to<span class="token operator">?</span><span class="token operator">:</span> RawLocation <span class="token operator">|</span> Route<span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> route<span class="token operator">:</span> any <span class="token operator">=</span> to
      <span class="token operator">?</span> to<span class="token punctuation">.</span>matched
        <span class="token operator">?</span> to
        <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">.</span>route
      <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currentRoute
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> route<span class="token punctuation">.</span>matched<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>components<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> m<span class="token punctuation">.</span>components<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">resolve</span> <span class="token punctuation">(</span>
    to<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span>
    current<span class="token operator">?</span><span class="token operator">:</span> Route<span class="token punctuation">,</span>
    append<span class="token operator">?</span><span class="token operator">:</span> boolean
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    location<span class="token operator">:</span> Location<span class="token punctuation">,</span>
    route<span class="token operator">:</span> Route<span class="token punctuation">,</span>
    href<span class="token operator">:</span> string<span class="token punctuation">,</span>
    normalizedTo<span class="token operator">:</span> Location<span class="token punctuation">,</span>
    resolved<span class="token operator">:</span> Route
  <span class="token punctuation">}</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">normalizeLocation</span><span class="token punctuation">(</span>
      to<span class="token punctuation">,</span>
      current <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span>current<span class="token punctuation">,</span>
      append<span class="token punctuation">,</span>
      <span class="token keyword">this</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> current<span class="token punctuation">)</span>
    <span class="token keyword">const</span> fullPath <span class="token operator">=</span> route<span class="token punctuation">.</span>redirectedFrom <span class="token operator">||</span> route<span class="token punctuation">.</span>fullPath
    <span class="token keyword">const</span> base <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span>base
    <span class="token keyword">const</span> href <span class="token operator">=</span> <span class="token function">createHref</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> fullPath<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mode<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      location<span class="token punctuation">,</span>
      route<span class="token punctuation">,</span>
      href<span class="token punctuation">,</span>
      normalizedTo<span class="token operator">:</span> location<span class="token punctuation">,</span>
      resolved<span class="token operator">:</span> route
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">addRoutes</span> <span class="token punctuation">(</span><span class="token parameter">routes<span class="token operator">:</span> Array<span class="token operator">&lt;</span>RouteConfig<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>matcher<span class="token punctuation">.</span><span class="token function">addRoutes</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span>current <span class="token operator">!==</span> <span class="token constant">START</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>VueRouter</code> å®šä¹‰äº†ä¸€äº›å±æ€§å’Œæ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆä»å®ƒçš„æ„é€ å‡½æ•°çœ‹ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œ <code>new VueRouter</code> çš„æ—¶å€™åšäº†å“ªäº›äº‹æƒ…ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token operator">:</span> RouterOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>apps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options
  <span class="token keyword">this</span><span class="token punctuation">.</span>beforeHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>resolveHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>afterHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>matcher <span class="token operator">=</span> <span class="token function">createMatcher</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>routes <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>

  <span class="token keyword">let</span> mode <span class="token operator">=</span> options<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token string">'hash'</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>fallback <span class="token operator">=</span> mode <span class="token operator">===</span> <span class="token string">'history'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>supportsPushState <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>fallback <span class="token operator">!==</span> <span class="token boolean">false</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mode <span class="token operator">=</span> <span class="token string">'hash'</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mode <span class="token operator">=</span> <span class="token string">'abstract'</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'history'</span><span class="token operator">:</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HTML5History</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token string">'hash'</span><span class="token operator">:</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fallback<span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token string">'abstract'</span><span class="token operator">:</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbstractHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assert</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">invalid mode: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ„é€ å‡½æ•°å®šä¹‰äº†ä¸€äº›å±æ€§ï¼Œå…¶ä¸­ <code>this.app</code> è¡¨ç¤ºæ ¹ Vue å®ä¾‹ï¼Œ<code>this.apps</code> ä¿å­˜æŒæœ‰ <code>$options.router</code> å±æ€§çš„ Vue å®ä¾‹ï¼Œ<code>this.options</code> ä¿å­˜ä¼ å…¥çš„è·¯ç”±é…ç½®ï¼Œ<code>this.beforeHooks</code>ã€ <code>this.resolveHooks</code>ã€<code>this.afterHooks</code> è¡¨ç¤ºä¸€äº›é’©å­å‡½æ•°ï¼Œæˆ‘ä»¬ä¹‹åä¼šä»‹ç»ï¼Œ<code>this.matcher</code>è¡¨ç¤ºè·¯ç”±åŒ¹é…å™¨ï¼Œæˆ‘ä»¬ä¹‹åä¼šä»‹ç»ï¼Œ<code>this.fallback</code> è¡¨ç¤ºåœ¨æµè§ˆå™¨ä¸æ”¯æŒ <code>history.pushState</code>çš„æƒ…å†µä¸‹ï¼Œæ ¹æ®ä¼ å…¥çš„ <code>fallback</code> é…ç½®å‚æ•°ï¼Œå†³å®šæ˜¯å¦å›é€€åˆ°hashæ¨¡å¼ï¼Œ<code>this.mode</code> è¡¨ç¤ºè·¯ç”±åˆ›å»ºçš„æ¨¡å¼ï¼Œ<code>this.history</code>è¡¨ç¤ºè·¯ç”±å†å²çš„å…·ä½“çš„å®ç°å®ä¾‹ï¼Œå®ƒæ˜¯æ ¹æ® <code>this.mode</code> çš„ä¸åŒå®ç°ä¸åŒï¼Œå®ƒæœ‰ <code>History</code> åŸºç±»ï¼Œç„¶åä¸åŒçš„ <code>history</code> å®ç°éƒ½æ˜¯ç»§æ‰¿ <code>History</code>ã€‚</p> <p>å®ä¾‹åŒ– <code>VueRouter</code> åä¼šè¿”å›å®ƒçš„å®ä¾‹ <code>router</code>ï¼Œæˆ‘ä»¬åœ¨ <code>new Vue</code> çš„æ—¶å€™ä¼šæŠŠ <code>router</code> ä½œä¸ºé…ç½®çš„å±æ€§ä¼ å…¥ï¼Œå›é¡¾ä¸€ä¸‹ä¸Šä¸€èŠ‚æˆ‘ä»¬è®² <code>beforeCreate</code> æ··å…¥çš„æ—¶å€™æœ‰è¿™ä¹ˆä¸€æ®µä»£ç ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">beforeCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router
    <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>  
</code></pre></div><p>æ‰€ä»¥ç»„ä»¶åœ¨æ‰§è¡Œ beforeCreate é’©å­å‡½æ•°çš„æ—¶å€™ï¼Œå¦‚æœä¼ å…¥äº† router å®ä¾‹ï¼Œéƒ½ä¼šæ‰§è¡Œ router.init æ–¹æ³•ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">init</span> <span class="token punctuation">(</span><span class="token parameter">app<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">assert</span><span class="token punctuation">(</span>
    install<span class="token punctuation">.</span>installed<span class="token punctuation">,</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">not installed. Make sure to call \`Vue.use(VueRouter)\` </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">before creating root instance.</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> app

  <span class="token keyword">const</span> history <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history

  <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HTML5History</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HashHistory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">setupHashListener</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      history<span class="token punctuation">.</span><span class="token function">setupListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>
      history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      setupHashListener<span class="token punctuation">,</span>
      setupHashListener
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      app<span class="token punctuation">.</span>_route <span class="token operator">=</span> route
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>init</code> çš„é€»è¾‘å¾ˆç®€å•ï¼Œå®ƒä¼ å…¥çš„å‚æ•°æ˜¯ Vue å®ä¾‹ï¼Œç„¶åå­˜å‚¨åˆ° <code>this.apps</code> ä¸­ï¼›åªæœ‰æ ¹ Vue å®ä¾‹ä¼šä¿å­˜åˆ° <code>this.app</code> ä¸­ï¼Œå¹¶ä¸”ä¼šæ‹¿åˆ°å½“å‰çš„ <code>this.history</code>ï¼Œæ ¹æ®å®ƒçš„ä¸åŒç±»å‹æ¥æ‰§è¡Œä¸åŒé€»è¾‘ï¼Œç”±äºæˆ‘ä»¬å¹³æ—¶ä½¿ç”¨ hash è·¯ç”±å¤šä¸€äº›ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆçœ‹è¿™éƒ¨åˆ†é€»è¾‘ï¼Œå…ˆå®šä¹‰äº† <code>setupHashListener</code> å‡½æ•°ï¼Œæ¥ç€æ‰§è¡Œäº† <code>history.transitionTo</code> æ–¹æ³•ï¼Œå®ƒæ˜¯å®šä¹‰åœ¨ History åŸºç±»ä¸­ï¼Œä»£ç åœ¨ <code>src/history/base.js</code>ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">transitionTo</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">)</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬å…ˆä¸ç€æ€¥å»çœ‹ transitionTo çš„å…·ä½“å®ç°ï¼Œå…ˆçœ‹ç¬¬ä¸€è¡Œä»£ç ï¼Œå®ƒè°ƒç”¨äº† <code>this.router.match</code> å‡½æ•°</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">match</span> <span class="token punctuation">(</span>
  raw<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span>
  current<span class="token operator">?</span><span class="token operator">:</span> Route<span class="token punctuation">,</span>
  redirectedFrom<span class="token operator">?</span><span class="token operator">:</span> Location
<span class="token punctuation">)</span><span class="token operator">:</span> Route <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>matcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> current<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å®é™…ä¸Šæ˜¯è°ƒç”¨äº† <code>this.matcher.match</code> æ–¹æ³•å»åšåŒ¹é…ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ matcher çš„ç›¸å…³å®ç°ã€‚</p> <h2 id="matcher">matcher</h2> <p><code>matcher</code>ç›¸å…³çš„å®ç°éƒ½åœ¨<code>src/create-matcher.js</code>ä¸­ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹<code>matcher</code>çš„æ•°æ®ç»“æ„</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> type Matcher <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">match</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">raw<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span> current<span class="token operator">?</span><span class="token operator">:</span> Route<span class="token punctuation">,</span> redirectedFrom<span class="token operator">?</span><span class="token operator">:</span> Location</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Route<span class="token punctuation">;</span>
  <span class="token function-variable function">addRoutes</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">routes<span class="token operator">:</span> Array<span class="token operator">&lt;</span>RouteConfig<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Matcher è¿”å›äº† 2 ä¸ªæ–¹æ³•ï¼Œmatch å’Œ addRoutesï¼Œåœ¨ä¸Šä¸€èŠ‚æˆ‘ä»¬æ¥è§¦åˆ°äº† match æ–¹æ³•ï¼Œé¡¾åæ€ä¹‰å®ƒæ˜¯åšåŒ¹é…ï¼Œé‚£ä¹ˆåŒ¹é…çš„æ˜¯ä»€ä¹ˆï¼Œåœ¨ä»‹ç»ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£è·¯ç”±ä¸­é‡è¦çš„ 2 ä¸ªæ¦‚å¿µï¼ŒLoaction å’Œ Routeï¼Œå®ƒä»¬çš„æ•°æ®ç»“æ„å®šä¹‰åœ¨ flow/declarations.js ä¸­ã€‚</p> <ul><li>Location</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>declare type Location <span class="token operator">=</span> <span class="token punctuation">{</span>
  _normalized<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">;</span>
  name<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  path<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  hash<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  query<span class="token operator">?</span><span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  params<span class="token operator">?</span><span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  append<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">;</span>
  replace<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Vue-Routerä¸­å®šä¹‰çš„<code>Location</code>æ•°æ®ç»“æ„å’Œæµè§ˆå™¨æä¾›çš„<code>window.location</code>éƒ¨åˆ†ç»“æ„æœ‰ç‚¹ç±»ä¼¼ï¼Œå®ƒä»¬éƒ½æ˜¯å¯¹<code>url</code>çš„ç»“æ„åŒ–æè¿°ã€‚ä¸¾ä¸ªä¾‹å­ï¼š<code>/abc?foo=bar&amp;baz=qux#hello</code>,å®ƒçš„<code>path</code>æ˜¯<code>/abc</code>ï¼Œ<code>query</code>æ˜¯<code>{foo:'bar',baz:'qux'}</code>ã€‚<code>Location</code>çš„å…¶ä»–å±æ€§æˆ‘ä»¬ä¹‹åä¼šä»‹ç»ã€‚</p> <ul><li>Route</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>declare type Route <span class="token operator">=</span> <span class="token punctuation">{</span>
  path<span class="token operator">:</span> string<span class="token punctuation">;</span>
  name<span class="token operator">:</span> <span class="token operator">?</span>string<span class="token punctuation">;</span>
  hash<span class="token operator">:</span> string<span class="token punctuation">;</span>
  query<span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  params<span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  fullPath<span class="token operator">:</span> string<span class="token punctuation">;</span>
  matched<span class="token operator">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  redirectedFrom<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  meta<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Route</code>è¡¨ç¤ºçš„æ˜¯è·¯ç”±ä¸­çš„ä¸€æ¡çº¿è·¯ï¼Œå®ƒé™¤äº†æè¿°ç±»ä¼¼<code>Location</code>çš„<code>path</code>ã€<code>query</code>ã€<code>hash</code>è¿™äº›æ¦‚å¿µï¼Œè¿˜æœ‰<code>matched</code>è¡¨ç¤ºåŒ¹é…åˆ°çš„æ‰€æœ‰çš„<code>RouteRecord</code>ã€‚<code>Route</code>çš„å…¶ä»–å±æ€§æˆ‘ä»¬ä¹‹åä¼šä»‹ç»ã€‚</p> <h3 id="creatematcher">createMatcher</h3> <p>åœ¨äº†è§£äº†<code>Location</code>å’Œ<code>Route</code>åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<code>matcher</code>çš„åˆ›å»ºè¿‡ç¨‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createMatcher</span> <span class="token punctuation">(</span>
  <span class="token parameter">routes<span class="token operator">:</span> Array<span class="token operator">&lt;</span>RouteConfig<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  router<span class="token operator">:</span> VueRouter</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Matcher <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>pathList<span class="token punctuation">,</span>pathMap<span class="token punctuation">,</span>nameMap<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createRouteMap</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span>
  <span class="token keyword">function</span> <span class="token function">addRoutes</span> <span class="token punctuation">(</span><span class="token parameter">routes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">createRouteMap</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span>pathList<span class="token punctuation">,</span>pathMap<span class="token punctuation">,</span>nameMap<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">match</span> <span class="token punctuation">(</span>
    <span class="token parameter">raw<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span>
    currentRoute<span class="token operator">?</span><span class="token operator">:</span> Route<span class="token punctuation">,</span>
    redirectedFrom<span class="token operator">?</span><span class="token operator">:</span> Location</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> Route <span class="token punctuation">{</span>
    <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">normalizeLocation</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span>currentRoute<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span>router<span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>name<span class="token punctuation">}</span> <span class="token operator">=</span> location
    <span class="token keyword">if</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> record <span class="token operator">=</span> nameMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Route with name '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' dose not exist</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>record<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>location<span class="token punctuation">)</span>
      <span class="token keyword">const</span> paramNames <span class="token operator">=</span> record<span class="token punctuation">.</span>regex<span class="token punctuation">.</span>keys
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>key<span class="token punctuation">.</span>optional<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> key<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> location<span class="token punctuation">.</span>params <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        location<span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentRoute <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> currentRoute<span class="token punctuation">.</span>params <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> currentRoute<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> location<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> paramNames<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            location<span class="token punctuation">.</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> currentRoute<span class="token punctuation">.</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        location<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token function">fillParams</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>path<span class="token punctuation">,</span> location<span class="token punctuation">.</span>params<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">named route &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">{</span>
      location<span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pathList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> path <span class="token operator">=</span> pathList<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">const</span> record <span class="token operator">=</span> pathMap<span class="token punctuation">[</span>path<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>regex<span class="token punctuation">,</span> location<span class="token punctuation">.</span>path<span class="token punctuation">,</span> location<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
     <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">function</span> <span class="token function">_createRoute</span> <span class="token punctuation">(</span>
    <span class="token parameter">record<span class="token operator">:</span> <span class="token operator">?</span>RouteRecord<span class="token punctuation">,</span>
    location<span class="token operator">:</span> Location<span class="token punctuation">,</span>
    redirectedFrom<span class="token operator">?</span><span class="token operator">:</span> Location</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> Route <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>redirect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> redirectedFrom <span class="token operator">||</span> location<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>matchAs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">alias</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> record<span class="token punctuation">.</span>matchAs<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">createRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">,</span> router<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    match<span class="token punctuation">,</span>
    addRoutes
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>createMatcher</code>æ¥æ”¶2ä¸ªå‚æ•°ï¼Œä¸€ä¸ª<code>router</code>ï¼Œå®ƒæ˜¯æˆ‘ä»¬<code>new VueRouter</code>è¿”å›çš„å®ä¾‹ï¼Œä¸€ä¸ªæ˜¯<code>routes</code>,å®ƒæ˜¯ç”¨æˆ·å®šä¹‰çš„è·¯ç”±é…ç½®ï¼Œæ¥çœ‹ä¸€ä¸‹æˆ‘ä»¬ä¹‹å‰ä¸¾çš„ä¾‹å­ä¸­çš„é…ç½®ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Foo <span class="token operator">=</span> <span class="token punctuation">{</span>template<span class="token operator">:</span><span class="token string">'&lt;div&gt;foo&lt;/div&gt;'</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> Bar <span class="token operator">=</span> <span class="token punctuation">{</span>template<span class="token operator">:</span><span class="token string">'&lt;div&gt;bar&lt;/div&gt;'</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>path<span class="token operator">:</span><span class="token string">'/foo'</span><span class="token punctuation">,</span>component<span class="token operator">:</span> Foo<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>path<span class="token operator">:</span><span class="token string">'/bar'</span><span class="token punctuation">,</span>component<span class="token operator">:</span> Bar<span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p><code>createMatcher</code>é¦–å…ˆæ‰§è¡Œçš„é€»è¾‘æ˜¯<code>const {pathList,pathMap,nameMap} = createRouteMap(routes)</code>åˆ›å»ºä¸€ä¸ªè·¯ç”±æ˜ å°„è¡¨ï¼Œ<code>createRouteMap</code>çš„å®šä¹‰åœ¨<code>src/create-route-map</code>ä¸­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRouteMap</span> <span class="token punctuation">(</span>
  <span class="token parameter">routes<span class="token operator">:</span> Array<span class="token operator">&lt;</span>RouteConfig<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  oldPathList<span class="token operator">?</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  oldPathMap<span class="token operator">?</span><span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  oldNameMap<span class="token operator">?</span><span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  pathList<span class="token operator">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  pathMap<span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  nameMap<span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> pathList<span class="token operator">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token operator">=</span> oldPathList <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> pathMap<span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span> <span class="token operator">=</span> oldPathMap <span class="token operator">||</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> nameMap<span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span> <span class="token operator">=</span> oldNameMap <span class="token operator">||</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>

  routes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">addRouteRecord</span><span class="token punctuation">(</span>pathList<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> nameMap<span class="token punctuation">,</span> route<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> pathList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pathList<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'*'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pathList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>pathList<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      l<span class="token operator">--</span>
      i<span class="token operator">--</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    pathList<span class="token punctuation">,</span>
    pathMap<span class="token punctuation">,</span>
    nameMap
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>createRouteMap</code> å‡½æ•°çš„ç›®æ ‡æ˜¯æŠŠç”¨æˆ·çš„è·¯ç”±é…ç½®è½¬æ¢æˆä¸€å¼ è·¯ç”±æ˜ å°„è¡¨ï¼Œå®ƒåŒ…å« 3 ä¸ªéƒ¨åˆ†ï¼Œ<code>pathList</code> å­˜å‚¨æ‰€æœ‰çš„ <code>path</code>ï¼Œ<code>pathMap</code> è¡¨ç¤ºä¸€ä¸ª <code>path</code> åˆ° <code>RouteRecord</code> çš„æ˜ å°„å…³ç³»ï¼Œè€Œ <code>nameMap</code> è¡¨ç¤º name åˆ° <code>RouteRecord</code> çš„æ˜ å°„å…³ç³»ã€‚é‚£ä¹ˆ <code>RouteRecord</code> åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹å®ƒçš„æ•°æ®ç»“æ„ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code>declare type RouteRecord <span class="token operator">=</span> <span class="token punctuation">{</span>
  path<span class="token operator">:</span> string<span class="token punctuation">;</span>
  regex<span class="token operator">:</span> RouteRegExp<span class="token punctuation">;</span>
  components<span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  instances<span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  name<span class="token operator">:</span> <span class="token operator">?</span>string<span class="token punctuation">;</span>
  parent<span class="token operator">:</span> <span class="token operator">?</span>RouteRecord<span class="token punctuation">;</span>
  redirect<span class="token operator">:</span> <span class="token operator">?</span>RedirectOption<span class="token punctuation">;</span>
  matchAs<span class="token operator">:</span> <span class="token operator">?</span>string<span class="token punctuation">;</span>
  beforeEnter<span class="token operator">:</span> <span class="token operator">?</span>NavigationGuard<span class="token punctuation">;</span>
  meta<span class="token operator">:</span> any<span class="token punctuation">;</span>
  props<span class="token operator">:</span> boolean <span class="token operator">|</span> Object <span class="token operator">|</span> Function <span class="token operator">|</span> Dictionary<span class="token operator">&lt;</span>boolean <span class="token operator">|</span> Object <span class="token operator">|</span> Function<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å®ƒçš„åˆ›å»ºæ˜¯é€šè¿‡éå† <code>routes</code> ä¸ºæ¯ä¸€ä¸ª <code>route</code> æ‰§è¡Œ <code>addRouteRecord</code> æ–¹æ³•ç”Ÿæˆä¸€æ¡è®°å½•ï¼Œæ¥çœ‹ä¸€ä¸‹å®ƒçš„å®šä¹‰ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">addRouteRecord</span> <span class="token punctuation">(</span>
  <span class="token parameter">pathList<span class="token operator">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  pathMap<span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  nameMap<span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  route<span class="token operator">:</span> RouteConfig<span class="token punctuation">,</span>
  parent<span class="token operator">?</span><span class="token operator">:</span> RouteRecord<span class="token punctuation">,</span>
  matchAs<span class="token operator">?</span><span class="token operator">:</span> string</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> route
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>path <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;path&quot; is required in a route configuration.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>
      <span class="token keyword">typeof</span> route<span class="token punctuation">.</span>component <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">route config &quot;component&quot; for path: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>path <span class="token operator">||</span> name<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> cannot be a </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">string id. Use an actual component instead.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> pathToRegexpOptions<span class="token operator">:</span> PathToRegexpOptions <span class="token operator">=</span> route<span class="token punctuation">.</span>pathToRegexpOptions <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">const</span> normalizedPath <span class="token operator">=</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>
    path<span class="token punctuation">,</span>
    parent<span class="token punctuation">,</span>
    pathToRegexpOptions<span class="token punctuation">.</span>strict
  <span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> route<span class="token punctuation">.</span>caseSensitive <span class="token operator">===</span> <span class="token string">'boolean'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pathToRegexpOptions<span class="token punctuation">.</span>sensitive <span class="token operator">=</span> route<span class="token punctuation">.</span>caseSensitive
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> record<span class="token operator">:</span> RouteRecord <span class="token operator">=</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> normalizedPath<span class="token punctuation">,</span>
    regex<span class="token operator">:</span> <span class="token function">compileRouteRegex</span><span class="token punctuation">(</span>normalizedPath<span class="token punctuation">,</span> pathToRegexpOptions<span class="token punctuation">)</span><span class="token punctuation">,</span>
    components<span class="token operator">:</span> route<span class="token punctuation">.</span>components <span class="token operator">||</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> route<span class="token punctuation">.</span>component <span class="token punctuation">}</span><span class="token punctuation">,</span>
    instances<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    parent<span class="token punctuation">,</span>
    matchAs<span class="token punctuation">,</span>
    redirect<span class="token operator">:</span> route<span class="token punctuation">.</span>redirect<span class="token punctuation">,</span>
    beforeEnter<span class="token operator">:</span> route<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">,</span>
    meta<span class="token operator">:</span> route<span class="token punctuation">.</span>meta <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    props<span class="token operator">:</span> route<span class="token punctuation">.</span>props <span class="token operator">==</span> <span class="token keyword">null</span>
      <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token operator">:</span> route<span class="token punctuation">.</span>components
        <span class="token operator">?</span> route<span class="token punctuation">.</span>props
        <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> route<span class="token punctuation">.</span>props <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>name <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>route<span class="token punctuation">.</span>redirect <span class="token operator">&amp;&amp;</span> route<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token regex">/^\/?$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Named Route '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>route<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' has a default child route. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">When navigating to this named route (:to=&quot;{name: '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>route<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'&quot;), </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">the default child route will not be rendered. Remove the name from </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">this route and use the name of the default child route for named </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">links instead.</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    route<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> childMatchAs <span class="token operator">=</span> matchAs
        <span class="token operator">?</span> <span class="token function">cleanPath</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>matchAs<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>child<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token keyword">undefined</span>
      <span class="token function">addRouteRecord</span><span class="token punctuation">(</span>pathList<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> nameMap<span class="token punctuation">,</span> child<span class="token punctuation">,</span> record<span class="token punctuation">,</span> childMatchAs<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>alias <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> aliases <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>alias<span class="token punctuation">)</span>
      <span class="token operator">?</span> route<span class="token punctuation">.</span>alias
      <span class="token operator">:</span> <span class="token punctuation">[</span>route<span class="token punctuation">.</span>alias<span class="token punctuation">]</span>

    aliases<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">alias</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> aliasRoute <span class="token operator">=</span> <span class="token punctuation">{</span>
        path<span class="token operator">:</span> alias<span class="token punctuation">,</span>
        children<span class="token operator">:</span> route<span class="token punctuation">.</span>children
      <span class="token punctuation">}</span>
      <span class="token function">addRouteRecord</span><span class="token punctuation">(</span>
        pathList<span class="token punctuation">,</span>
        pathMap<span class="token punctuation">,</span>
        nameMap<span class="token punctuation">,</span>
        aliasRoute<span class="token punctuation">,</span>
        parent<span class="token punctuation">,</span>
        record<span class="token punctuation">.</span>path <span class="token operator">||</span> <span class="token string">'/'</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pathMap<span class="token punctuation">[</span>record<span class="token punctuation">.</span>path<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pathList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
    pathMap<span class="token punctuation">[</span>record<span class="token punctuation">.</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> record
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nameMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      nameMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> record
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>matchAs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Duplicate named routes definition: </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{ name: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;, path: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>record<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; }</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> record<span class="token operator">:</span> RouteRecord <span class="token operator">=</span> <span class="token punctuation">{</span>
  path<span class="token operator">:</span> normalizedPath<span class="token punctuation">,</span>
  regex<span class="token operator">:</span> <span class="token function">compileRouteRegex</span><span class="token punctuation">(</span>normalizedPath<span class="token punctuation">,</span> pathToRegexpOptions<span class="token punctuation">)</span><span class="token punctuation">,</span>
  components<span class="token operator">:</span> route<span class="token punctuation">.</span>components <span class="token operator">||</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> route<span class="token punctuation">.</span>component <span class="token punctuation">}</span><span class="token punctuation">,</span>
  instances<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  name<span class="token punctuation">,</span>
  parent<span class="token punctuation">,</span>
  matchAs<span class="token punctuation">,</span>
  redirect<span class="token operator">:</span> route<span class="token punctuation">.</span>redirect<span class="token punctuation">,</span>
  beforeEnter<span class="token operator">:</span> route<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">,</span>
  meta<span class="token operator">:</span> route<span class="token punctuation">.</span>meta <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> route<span class="token punctuation">.</span>props <span class="token operator">==</span> <span class="token keyword">null</span>
    <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token operator">:</span> route<span class="token punctuation">.</span>components
      <span class="token operator">?</span> route<span class="token punctuation">.</span>props
      <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> route<span class="token punctuation">.</span>props <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™é‡Œè¦æ³¨æ„å‡ ä¸ªç‚¹ï¼Œ<code>path</code> æ˜¯è§„èŒƒåŒ–åçš„è·¯å¾„ï¼Œå®ƒä¼šæ ¹æ® <code>parent</code> çš„ <code>path</code> åšè®¡ç®—ï¼›<code>regex</code> æ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„æ‰©å±•ï¼Œå®ƒåˆ©ç”¨äº†<code>path-to-regexp</code> è¿™ä¸ªå·¥å…·åº“ï¼ŒæŠŠ <code>path</code> è§£ææˆä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„æ‰©å±•ï¼Œä¸¾ä¸ªä¾‹å­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">var</span> re <span class="token operator">=</span> <span class="token function">pathToRegexp</span><span class="token punctuation">(</span><span class="token string">'/foo/:bar'</span><span class="token punctuation">,</span> keys<span class="token punctuation">)</span>
<span class="token comment">// re = /^\/foo\/([^\/]+?)\/?$/i</span>
<span class="token comment">// keys = [{ name: 'bar', prefix: '/', delimiter: '/', optional: false, repeat: false, pattern: '[^\\/]+?' }]</span>
</code></pre></div><p><code>components</code> æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé€šå¸¸æˆ‘ä»¬åœ¨é…ç½®ä¸­å†™çš„ <code>component</code> å®é™…ä¸Šè¿™é‡Œä¼šè¢«è½¬æ¢æˆ <code>{components: route.component}</code>ï¼›<code>instances</code> è¡¨ç¤ºç»„ä»¶çš„å®ä¾‹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ç±»å‹ï¼›<code>parent</code> è¡¨ç¤ºçˆ¶çš„ <code>RouteRecord</code>ï¼Œå› ä¸ºæˆ‘ä»¬é…ç½®çš„æ—¶å€™æœ‰æ—¶å€™ä¼šé…ç½®å­è·¯ç”±ï¼Œæ‰€ä»¥æ•´ä¸ª <code>RouteRecord</code> ä¹Ÿå°±æ˜¯ä¸€ä¸ªæ ‘å‹ç»“æ„ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  route<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> childMatchAs <span class="token operator">=</span> matchAs
    <span class="token operator">?</span> <span class="token function">cleanPath</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>matchAs<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>child<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token keyword">undefined</span>
  <span class="token function">addRouteRecord</span><span class="token punctuation">(</span>pathList<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> nameMap<span class="token punctuation">,</span> child<span class="token punctuation">,</span> record<span class="token punctuation">,</span> childMatchAs<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¦‚æœé…ç½®äº† <code>children</code>ï¼Œé‚£ä¹ˆé€’å½’æ‰§è¡Œ <code>addRouteRecord</code> æ–¹æ³•ï¼Œå¹¶æŠŠå½“å‰çš„ <code>record</code> ä½œä¸º <code>parent</code> ä¼ å…¥ï¼Œé€šè¿‡è¿™æ ·çš„æ·±åº¦éå†ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‹¿åˆ°ä¸€ä¸ª <code>route</code> ä¸‹çš„å®Œæ•´è®°å½•ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pathMap<span class="token punctuation">[</span>record<span class="token punctuation">.</span>path<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pathList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
  pathMap<span class="token punctuation">[</span>record<span class="token punctuation">.</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> record
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸º <code>pathList</code> å’Œ <code>pathMap</code> å„æ·»åŠ ä¸€æ¡è®°å½•</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>nameMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    nameMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> record
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¦‚æœæˆ‘ä»¬åœ¨è·¯ç”±é…ç½®ä¸­é…ç½®äº† <code>name</code>ï¼Œåˆ™ç»™ <code>nameMap</code> æ·»åŠ ä¸€æ¡è®°å½•ã€‚</p> <p>ç”±äº <code>pathList</code>ã€<code>pathMap</code>ã€<code>nameMap</code> éƒ½æ˜¯å¼•ç”¨ç±»å‹ï¼Œæ‰€ä»¥åœ¨éå†æ•´ä¸ª <code>routes</code> è¿‡ç¨‹ä¸­å»æ‰§è¡Œ <code>addRouteRecord</code> æ–¹æ³•ï¼Œä¼šä¸æ–­ç»™ä»–ä»¬æ·»åŠ æ•°æ®ã€‚é‚£ä¹ˆç»è¿‡æ•´ä¸ª <code>createRouteMap</code> æ–¹æ³•çš„æ‰§è¡Œï¼Œæˆ‘ä»¬å¾—åˆ°çš„å°±æ˜¯ <code>pathList</code>ã€<code>pathMap</code> å’Œ <code>nameMap</code>ã€‚å…¶ä¸­ <code>pathList</code> æ˜¯ä¸ºäº†è®°å½•è·¯ç”±é…ç½®ä¸­çš„æ‰€æœ‰ <code>path</code>ï¼Œè€Œ <code>pathMap</code> å’Œ <code>nameMap</code> éƒ½æ˜¯ä¸ºäº†é€šè¿‡ <code>path</code> å’Œ <code>name</code> èƒ½å¿«é€ŸæŸ¥åˆ°å¯¹åº”çš„ <code>RouteRecord</code>ã€‚</p> <p>å†å›åˆ° <code>createMatcher</code> å‡½æ•°ï¼Œæ¥ä¸‹æ¥å°±å®šä¹‰äº†ä¸€ç³»åˆ—æ–¹æ³•ï¼Œæœ€åè¿”å›äº†ä¸€ä¸ªå¯¹è±¡ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">return</span> <span class="token punctuation">{</span>
  match<span class="token punctuation">,</span>
  addRoutes
<span class="token punctuation">}</span>
</code></pre></div><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>matcher</code> æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒå¯¹å¤–æš´éœ²äº† <code>match</code> å’Œ <code>addRoutes</code> æ–¹æ³•ã€‚</p> <h3 id="addroutes">addRoutes</h3> <p><code>addRoutes</code>æ–¹æ³•çš„ä½œç”¨æ˜¯åŠ¨æ€æ·»åŠ è·¯ç”±é…ç½®ï¼Œå› ä¸ºåœ¨å®é™…å¼€å‘ä¸­æœ‰äº›åœºæ™¯æ˜¯ä¸èƒ½æå‰æŠŠè·¯ç”±å†™æ­»çš„ï¼Œéœ€è¦æ ¹æ®ä¸€äº›æ¡ä»¶æ·»åŠ è·¯ç”±ï¼Œæ‰€ä»¥Vue-Routerä¹Ÿæä¾›äº†è¿™ä¸€æ¥å£ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">addRoutes</span><span class="token punctuation">(</span><span class="token parameter">routes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">createRouteMap</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span>pathList<span class="token punctuation">,</span>pathMap<span class="token punctuation">,</span>nameMap<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>addRoutes</code>çš„æ–¹æ³•ååˆ†ç®€å•ï¼Œå†æ¬¡è°ƒç”¨<code>createRouteMap</code>å³å¯ï¼Œä¼ å…¥æ–°çš„<code>routes</code>é…ç½®ï¼Œç”±äº<code>pathList</code>ã€<code>pathMap</code>ã€<code>nameMap</code>éƒ½æ˜¯å¼•ç”¨ç±»å‹ï¼Œæ‰§è¡Œ<code>addRoutes</code>åä¼šä¿®æ”¹å®ƒä»¬çš„å€¼ã€‚</p> <h3 id="matcher-2">matcher</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">match</span> <span class="token punctuation">(</span>
  <span class="token parameter">raw<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span>
  currentRoute<span class="token operator">?</span><span class="token operator">:</span> Route<span class="token punctuation">,</span>
  redirectedFrom<span class="token operator">?</span><span class="token operator">:</span> Location</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Route <span class="token punctuation">{</span>
  <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">normalizeLocation</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> currentRoute<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> router<span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> location

  <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> record <span class="token operator">=</span> nameMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Route with name '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' does not exist</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>record<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span>
    <span class="token keyword">const</span> paramNames <span class="token operator">=</span> record<span class="token punctuation">.</span>regex<span class="token punctuation">.</span>keys
      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>key<span class="token punctuation">.</span>optional<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> key<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> location<span class="token punctuation">.</span>params <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      location<span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentRoute <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> currentRoute<span class="token punctuation">.</span>params <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> currentRoute<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> location<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> paramNames<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          location<span class="token punctuation">.</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> currentRoute<span class="token punctuation">.</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      location<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token function">fillParams</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>path<span class="token punctuation">,</span> location<span class="token punctuation">.</span>params<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">named route &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    location<span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pathList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> path <span class="token operator">=</span> pathList<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">const</span> record <span class="token operator">=</span> pathMap<span class="token punctuation">[</span>path<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>regex<span class="token punctuation">,</span> location<span class="token punctuation">.</span>path<span class="token punctuation">,</span> location<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>match</code> æ–¹æ³•æ¥æ”¶ 3 ä¸ªå‚æ•°ï¼Œå…¶ä¸­ <code>raw</code> æ˜¯ <code>RawLocation</code> ç±»å‹ï¼Œå®ƒå¯ä»¥æ˜¯ä¸€ä¸ª <code>url</code> å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ª <code>Location</code> å¯¹è±¡ï¼›<code>currentRoute</code> æ˜¯ <code>Route</code> ç±»å‹ï¼Œå®ƒè¡¨ç¤ºå½“å‰çš„è·¯å¾„ï¼›<code>redirectedFrom</code> å’Œé‡å®šå‘ç›¸å…³ï¼Œè¿™é‡Œå…ˆå¿½ç•¥ã€‚<code>match</code> æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªè·¯å¾„ï¼Œå®ƒçš„ä½œç”¨æ˜¯æ ¹æ®ä¼ å…¥çš„ <code>raw</code> å’Œå½“å‰çš„è·¯å¾„ <code>currentRoute</code> è®¡ç®—å‡ºä¸€ä¸ªæ–°çš„è·¯å¾„å¹¶è¿”å›ã€‚</p> <p>é¦–å…ˆæ‰§è¡Œäº† <code>normalizeLocation</code>ï¼Œå®ƒçš„å®šä¹‰åœ¨ <code>src/util/location.js</code> ä¸­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">normalizeLocation</span> <span class="token punctuation">(</span>
  <span class="token parameter">raw<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span>
  current<span class="token operator">:</span> <span class="token operator">?</span>Route<span class="token punctuation">,</span>
  append<span class="token operator">:</span> <span class="token operator">?</span>boolean<span class="token punctuation">,</span>
  router<span class="token operator">:</span> <span class="token operator">?</span>VueRouter</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Location <span class="token punctuation">{</span>
  <span class="token keyword">let</span> next<span class="token operator">:</span> Location <span class="token operator">=</span> <span class="token keyword">typeof</span> raw <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> <span class="token punctuation">{</span> path<span class="token operator">:</span> raw <span class="token punctuation">}</span> <span class="token operator">:</span> raw
  <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>name <span class="token operator">||</span> next<span class="token punctuation">.</span>_normalized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> next
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>next<span class="token punctuation">.</span>path <span class="token operator">&amp;&amp;</span> next<span class="token punctuation">.</span>params <span class="token operator">&amp;&amp;</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    next <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span>
    next<span class="token punctuation">.</span>_normalized <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">const</span> params<span class="token operator">:</span> any <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> current<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">,</span> next<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      next<span class="token punctuation">.</span>name <span class="token operator">=</span> current<span class="token punctuation">.</span>name
      next<span class="token punctuation">.</span>params <span class="token operator">=</span> params
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> rawPath <span class="token operator">=</span> current<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>current<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>path
      next<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token function">fillParams</span><span class="token punctuation">(</span>rawPath<span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">path </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>current<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">relative params navigation requires a current route.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> next
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> parsedPath <span class="token operator">=</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>path <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> basePath <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">&amp;&amp;</span> current<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'/'</span>
  <span class="token keyword">const</span> path <span class="token operator">=</span> parsedPath<span class="token punctuation">.</span>path
    <span class="token operator">?</span> <span class="token function">resolvePath</span><span class="token punctuation">(</span>parsedPath<span class="token punctuation">.</span>path<span class="token punctuation">,</span> basePath<span class="token punctuation">,</span> append <span class="token operator">||</span> next<span class="token punctuation">.</span>append<span class="token punctuation">)</span>
    <span class="token operator">:</span> basePath

  <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token function">resolveQuery</span><span class="token punctuation">(</span>
    parsedPath<span class="token punctuation">.</span>query<span class="token punctuation">,</span>
    next<span class="token punctuation">.</span>query<span class="token punctuation">,</span>
    router <span class="token operator">&amp;&amp;</span> router<span class="token punctuation">.</span>options<span class="token punctuation">.</span>parseQuery
  <span class="token punctuation">)</span>

  <span class="token keyword">let</span> hash <span class="token operator">=</span> next<span class="token punctuation">.</span>hash <span class="token operator">||</span> parsedPath<span class="token punctuation">.</span>hash
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hash <span class="token operator">&amp;&amp;</span> hash<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'#'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    hash <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hash<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    _normalized<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    path<span class="token punctuation">,</span>
    query<span class="token punctuation">,</span>
    hash
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>normalizeLocation</code> æ–¹æ³•çš„ä½œç”¨æ˜¯æ ¹æ® <code>raw</code>ï¼Œ<code>current</code> è®¡ç®—å‡ºæ–°çš„ <code>location</code>ï¼Œå®ƒä¸»è¦å¤„ç†äº† <code>raw</code> çš„ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯æœ‰ <code>params</code> ä¸”æ²¡æœ‰ <code>path</code>ï¼Œä¸€ç§æ˜¯æœ‰ <code>path</code> çš„ï¼Œå¯¹äºç¬¬ä¸€ç§æƒ…å†µï¼Œå¦‚æœ <code>current</code> æœ‰ <code>name</code>ï¼Œåˆ™è®¡ç®—å‡ºçš„ <code>location</code> ä¹Ÿæœ‰ <code>name</code>ã€‚</p> <p>è®¡ç®—å‡ºæ–°çš„ <code>location</code> åï¼Œå¯¹ <code>location</code> çš„ <code>name</code> å’Œ <code>path</code> çš„ä¸¤ç§æƒ…å†µåšäº†å¤„ç†ã€‚</p> <ul><li>name
æœ‰ <code>name</code> çš„æƒ…å†µä¸‹å°±æ ¹æ® <code>nameMap</code> åŒ¹é…åˆ° <code>record</code>ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ª <code>RouterRecord</code> å¯¹è±¡ï¼Œå¦‚æœ <code>record</code> ä¸å­˜åœ¨ï¼Œåˆ™åŒ¹é…å¤±è´¥ï¼Œè¿”å›ä¸€ä¸ªç©ºè·¯å¾„ï¼›ç„¶åæ‹¿åˆ° <code>record</code> å¯¹åº”çš„ <code>paramNames</code>ï¼Œå†å¯¹æ¯” <code>currentRoute</code> ä¸­çš„ <code>params</code>ï¼ŒæŠŠäº¤é›†éƒ¨åˆ†çš„ <code>params</code> æ·»åŠ åˆ° <code>location</code> ä¸­ï¼Œç„¶ååœ¨é€šè¿‡ <code>fillParams</code> æ–¹æ³•æ ¹æ® <code>record.path</code> å’Œ <code>location.path</code> è®¡ç®—å‡º <code>location.path</code>ï¼Œæœ€åè°ƒç”¨ <code>_createRoute(record, location, redirectedFrom)</code> å»ç”Ÿæˆä¸€æ¡æ–°è·¯å¾„ï¼Œè¯¥æ–¹æ³•æˆ‘ä»¬ä¹‹åä¼šä»‹ç»ã€‚</li> <li>path
é€šè¿‡ <code>name</code> æˆ‘ä»¬å¯ä»¥å¾ˆå¿«çš„æ‰¾åˆ° <code>record</code>ï¼Œä½†æ˜¯é€šè¿‡ <code>path</code> å¹¶ä¸èƒ½ï¼Œå› ä¸ºæˆ‘ä»¬è®¡ç®—åçš„ <code>location.path</code> æ˜¯ä¸€ä¸ªçœŸå®è·¯å¾„ï¼Œè€Œ <code>record</code> ä¸­çš„ <code>path</code> å¯èƒ½ä¼šæœ‰ <code>param</code>ï¼Œå› æ­¤éœ€è¦å¯¹æ‰€æœ‰çš„ <code>pathList</code> åšé¡ºåºéå†ï¼Œ ç„¶åé€šè¿‡ <code>matchRoute</code> æ–¹æ³•æ ¹æ® <code>record.regex</code>ã€<code>location.path</code>ã€<code>location.params</code> åŒ¹é…ï¼Œå¦‚æœåŒ¹é…åˆ°åˆ™ä¹Ÿé€šè¿‡ <code>_createRoute(record, location, redirectedFrom)</code> å»ç”Ÿæˆä¸€æ¡æ–°è·¯å¾„ã€‚å› ä¸ºæ˜¯é¡ºåºéå†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹¦å†™è·¯ç”±é…ç½®è¦æ³¨æ„è·¯å¾„çš„é¡ºåºï¼Œå› ä¸ºå†™åœ¨å‰é¢çš„ä¼šä¼˜å…ˆå°è¯•åŒ¹é…ã€‚</li></ul> <p>æœ€åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ <code>_createRoute</code> çš„å®ç°ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">_createRoute</span> <span class="token punctuation">(</span>
  <span class="token parameter">record<span class="token operator">:</span> <span class="token operator">?</span>RouteRecord<span class="token punctuation">,</span>
  location<span class="token operator">:</span> Location<span class="token punctuation">,</span>
  redirectedFrom<span class="token operator">?</span><span class="token operator">:</span> Location</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Route <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>redirect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> redirectedFrom <span class="token operator">||</span> location<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>matchAs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">alias</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> record<span class="token punctuation">.</span>matchAs<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">createRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">,</span> router<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬å…ˆä¸è€ƒè™‘ <code>record.redirect</code> å’Œ <code>record.matchAs</code> çš„æƒ…å†µï¼Œæœ€ç»ˆä¼šè°ƒç”¨ <code>createRoute</code> æ–¹æ³•ï¼Œå®ƒçš„å®šä¹‰åœ¨ <code>src/uitl/route.js</code> ä¸­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRoute</span> <span class="token punctuation">(</span>
  <span class="token parameter">record<span class="token operator">:</span> <span class="token operator">?</span>RouteRecord<span class="token punctuation">,</span>
  location<span class="token operator">:</span> Location<span class="token punctuation">,</span>
  redirectedFrom<span class="token operator">?</span><span class="token operator">:</span> <span class="token operator">?</span>Location<span class="token punctuation">,</span>
  router<span class="token operator">?</span><span class="token operator">:</span> VueRouter</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Route <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stringifyQuery <span class="token operator">=</span> router <span class="token operator">&amp;&amp;</span> router<span class="token punctuation">.</span>options<span class="token punctuation">.</span>stringifyQuery

  <span class="token keyword">let</span> query<span class="token operator">:</span> any <span class="token operator">=</span> location<span class="token punctuation">.</span>query <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    query <span class="token operator">=</span> <span class="token function">clone</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">const</span> route<span class="token operator">:</span> Route <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> location<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
    meta<span class="token operator">:</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>meta<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    path<span class="token operator">:</span> location<span class="token punctuation">.</span>path <span class="token operator">||</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
    hash<span class="token operator">:</span> location<span class="token punctuation">.</span>hash <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
    query<span class="token punctuation">,</span>
    params<span class="token operator">:</span> location<span class="token punctuation">.</span>params <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    fullPath<span class="token operator">:</span> <span class="token function">getFullPath</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> stringifyQuery<span class="token punctuation">)</span><span class="token punctuation">,</span>
    matched<span class="token operator">:</span> record <span class="token operator">?</span> <span class="token function">formatMatch</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>redirectedFrom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    route<span class="token punctuation">.</span>redirectedFrom <span class="token operator">=</span> <span class="token function">getFullPath</span><span class="token punctuation">(</span>redirectedFrom<span class="token punctuation">,</span> stringifyQuery<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>createRoute</code>å¯ä»¥æ ¹æ®<code>record</code>å’Œ<code>location</code>åˆ›å»ºå‡ºæ¥ï¼Œæœ€ç»ˆè¿”å›çš„æ˜¯ä¸€æ¡<code>Route</code>è·¯å¾„ï¼Œæˆ‘ä»¬ä¹‹å‰ä¹Ÿä»‹ç»è¿‡å®ƒçš„æ•°æ®ç»“æ„ã€‚åœ¨Vue-Routerä¸­ï¼Œæ‰€æœ‰çš„<code>Route</code>æœ€ç»ˆéƒ½ä¼šé€šè¿‡<code>createRoute</code>å‡½æ•°åˆ›å»ºï¼Œå¹¶ä¸”å®ƒæœ€åæ˜¯ä¸å¯ä»¥è¢«å¤–éƒ¨ä¿®æ”¹çš„ã€‚<code>Route</code>å¯¹è±¡ä¸­æœ‰ä¸€ä¸ªéå¸¸é‡è¦å±æ€§æ˜¯<code>matched</code>ï¼Œå®ƒé€šè¿‡<code>formatMatch(record)</code>è®¡ç®—è€Œæ¥ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">formatMatch</span><span class="token punctuation">(</span><span class="token parameter">record<span class="token operator">:</span> <span class="token operator">?</span>RouteRecord</span><span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span>
    record <span class="token operator">=</span> record<span class="token punctuation">.</span>parent
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥çœ‹å®ƒæ˜¯é€šè¿‡<code>record</code>å¾ªç¯å‘ä¸Šæ‰¾<code>parent</code>ï¼Œç›´åˆ°æ‰¾åˆ°æœ€å¤–å±‚ï¼Œå¹¶æŠŠæ‰€æœ‰çš„<code>record</code>éƒ½pushåˆ°ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œæœ€ç»ˆè¿”å›çš„å°±æ˜¯<code>record</code>çš„æ•°ç»„ï¼Œå®ƒè®°å½•äº†ä¸€æ¡çº¿è·¯ä¸Šçš„æ‰€æœ‰<code>record</code>ã€‚<code>matched</code>å±æ€§éå¸¸æœ‰ç”¨ï¼Œå®ƒä¸ºä¹‹åæ¸²æŸ“ç»„ä»¶æä¾›äº†ä¾æ®</p> <h3 id="è·¯ç”±åˆ‡æ¢">è·¯ç”±åˆ‡æ¢</h3> <p><code>history.transitionTo</code>æ˜¯Vue-Routerä¸­éå¸¸é‡è¦çš„æ–¹æ³•ï¼Œå½“æˆ‘ä»¬åˆ‡æ¢è·¯ç”±çº¿è·¯çš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡Œè¯¥æ–¹æ³•ï¼Œå‰ä¸€èŠ‚æˆ‘ä»¬åˆ†æäº†<code>matcher</code>çš„ç›¸å…³å®ç°ï¼ŒçŸ¥é“å®ƒæ˜¯å¦‚ä½•æ‰¾åˆ°åŒ¹é…çš„æ–°çº¿è·¯ï¼Œé‚£ä¹ˆåŒ¹é…åˆ°æ–°çº¿è·¯ååˆåšäº†å“ªäº›äº‹æƒ…ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æˆ‘ä»¬å®Œæ•´åˆ†æä¸€ä¸‹<code>transitionTo</code>çš„å®ç°ï¼Œå®ƒçš„å®šä¹‰åœ¨ <code>src/history/base.js</code>ä¸­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">transitionTo</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">confirmTransition</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
    onComplete <span class="token operator">&amp;&amp;</span> <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>readyCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>onAbort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">onAbort</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>readyErrorCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>transitionTo</code>é¦–å…ˆæ ¹æ®ç›®æ ‡<code>location</code>å’Œå½“å‰è·¯å¾„<code>this.current</code>æ‰§è¡Œ<code>this.router.match</code>æ–¹æ³•å»åŒ¹é…åˆ°ç›®æ ‡çš„è·¯å¾„ã€‚è¿™é‡Œ<code>this.current</code>æ˜¯<code>history</code>ç»´æŠ¤çš„å½“å‰è·¯å¾„ï¼Œå®ƒçš„åˆå§‹å€¼æ˜¯åœ¨<code>history</code>çš„æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–çš„ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token constant">START</span>
</code></pre></div><p><code>START</code>çš„å®šä¹‰åœ¨<code>src/util/route.js</code>ä¸­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">START</span> <span class="token operator">=</span> <span class="token function">createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
  path<span class="token operator">:</span> <span class="token string">'/'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>è¿™æ ·å°±åˆ›å»ºäº†ä¸€ä¸ªåˆå§‹åŒ–çš„<code>Route</code>,è€Œ<code>transitionTo</code>å®é™…ä¸Šä¹Ÿå°±æ˜¯åœ¨åˆ‡æ¢<code>this.current</code>,ç¨åæˆ‘ä»¬ä¼šçœ‹åˆ°ã€‚
æ‹¿åˆ°æ–°çš„è·¯å¾„åï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±ä¼šæ‰§è¡Œ<code>confirmTransition</code>æ–¹æ³•å»åšçœŸæ­£çš„åˆ‡æ¢ï¼Œç”±äºè¿™ä¸ªè¿‡ç¨‹å¯èƒ½æœ‰ä¸€äº›å¼‚æ­¥çš„æ“ä½œï¼ˆå¦‚å¼‚æ­¥ç»„ä»¶ï¼‰ï¼Œæ‰€ä»¥æ•´ä¸ª<code>confirmTransition</code>APIè®¾è®¡æˆå¸¦æœ‰æˆåŠŸå›è°ƒå‡½æ•°å’Œå¤±è´¥å›è°ƒå‡½æ•°ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹å®ƒçš„å®šä¹‰ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">confirmTransition</span> <span class="token punctuation">(</span><span class="token parameter">route<span class="token operator">:</span> Route<span class="token punctuation">,</span> onComplete<span class="token operator">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current
  <span class="token keyword">const</span> <span class="token function-variable function">abort</span> <span class="token operator">=</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>errorCbs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">'uncaught error during route navigation:'</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    onAbort <span class="token operator">&amp;&amp;</span> <span class="token function">onAbort</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token function">isSameRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> current<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    route<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">===</span> current<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    updated<span class="token punctuation">,</span>
    deactivated<span class="token punctuation">,</span>
    activated
  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">resolveQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>matched<span class="token punctuation">,</span> route<span class="token punctuation">.</span>matched<span class="token punctuation">)</span>

  <span class="token keyword">const</span> queue<span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
    <span class="token function">extractLeaveGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span>
    <span class="token function">extractUpdateHooks</span><span class="token punctuation">(</span>updated<span class="token punctuation">)</span><span class="token punctuation">,</span>
    activated<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">resolveAsyncComponents</span><span class="token punctuation">(</span>activated<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> route
  <span class="token keyword">const</span> <span class="token function-variable function">iterator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">hook<span class="token operator">:</span> NavigationGuard<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">hook</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">to<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>to <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">||</span> <span class="token function">isError</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
          <span class="token function">abort</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
          <span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span>
          <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
            <span class="token keyword">typeof</span> to<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span>
            <span class="token keyword">typeof</span> to<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'string'</span>
          <span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> to<span class="token punctuation">.</span>replace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">next</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">abort</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> postEnterCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> <span class="token function-variable function">isValid</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">===</span> route
    <span class="token keyword">const</span> enterGuards <span class="token operator">=</span> <span class="token function">extractEnterGuards</span><span class="token punctuation">(</span>activated<span class="token punctuation">,</span> postEnterCbs<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>
    <span class="token keyword">const</span> queue <span class="token operator">=</span> enterGuards<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>resolveHooks<span class="token punctuation">)</span>
    <span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          postEnterCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é¦–å…ˆå®šä¹‰äº†<code>abort</code>å‡½æ•°ï¼Œç„¶ååˆ¤æ–­å¦‚æœæ»¡è¶³è®¡ç®—åçš„<code>route</code>å’Œ<code>current</code>æ˜¯ç›¸åŒè·¯å¾„çš„è¯ï¼Œåˆ™ç›´æ¥è°ƒç”¨<code>this.ensureUrl</code>å’Œ<code>abort</code>ï¼Œ<code>ensureUrl</code>è¿™ä¸ªå‡½æ•°æˆ‘ä»¬ä¹‹åä¼šä»‹ç»ã€‚
æ¥ç€åˆæ ¹æ®<code>current.matched</code>å’Œ<code>route.matched</code>æ‰§è¡Œäº†<code>resolveQueue</code>æ–¹æ³•è§£æå‡º3ä¸ªé˜Ÿåˆ—ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">resolveQueue</span> <span class="token punctuation">(</span>
  <span class="token parameter">current<span class="token operator">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  next<span class="token operator">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  updated<span class="token operator">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  activated<span class="token operator">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  deactivated<span class="token operator">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span>
<span class="token punctuation">}</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> i
  <span class="token keyword">const</span> max <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>length<span class="token punctuation">,</span>next<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>current<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!==</span> next<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    updated<span class="token operator">:</span> next<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>
    activated<span class="token operator">:</span> next<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>
    deactivated<span class="token operator">:</span> current<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å› ä¸º<code>route.matched</code>æ˜¯ä¸€ä¸ª<code>RouteRecord</code>çš„æ•°ç»„ï¼Œç”±äºè·¯å¾„æ˜¯ç”±<code>current</code>å˜å‘<code>route</code>,é‚£ä¹ˆå°±éå†å¯¹æ¯”2è¾¹çš„<code>RouteRecord</code>ï¼Œæ‰¾åˆ°ä¸€ä¸ªä¸ä¸€æ ·çš„ä½ç½®<code>i</code>ï¼Œé‚£ä¹ˆ<code>next</code>ä¸­ä»0åˆ°<code>i</code>çš„<code>RouteRecord</code>æ˜¯ä¸¤è¾¹éƒ½ä¸€æ ·ï¼Œåˆ™ä¸º<code>updated</code>çš„éƒ¨åˆ†ï¼›ä»<code>i</code>åˆ°æœ€å<code>RouteRecord</code>æ˜¯<code>next</code>ç‹¬æœ‰çš„ï¼Œä¸º<code>activated</code>çš„éƒ¨åˆ†ï¼›è€Œ<code>current</code>ä¸­ä»<code>i</code>åˆ°æœ€åçš„<code>RouteRecord</code>åˆ™æ²¡æœ‰äº†ï¼Œä¸º<code>deactivated</code>çš„éƒ¨åˆ†ã€‚
æ‹¿åˆ°<code>updated</code>ã€<code>activated</code>ã€<code>deactivated</code>3ä¸ª<code>RouteRecord</code>æ•°ç»„åï¼Œæ¥ä¸‹æ¥å°±æ˜¯è·¯å¾„å˜æ¢åçš„ä¸€ä¸ªé‡è¦éƒ¨åˆ†ï¼Œæ‰§è¡Œä¸€ç³»åˆ—çš„é’©å­å‡½æ•°ã€‚</p> <h4 id="å¯¼èˆªå®ˆå«">å¯¼èˆªå®ˆå«</h4> <p>å®˜æ–¹çš„è¯´æ³•å«å¯¼èˆªå®ˆå«ï¼Œå®é™…ä¸Šå°±æ˜¯å‘ç”Ÿåœ¨è·¯ç”±è·¯å¾„åˆ‡æ¢çš„æ—¶å€™ï¼Œæ‰§è¡Œçš„ä¸€ç³»åˆ—é’©å­å‡½æ•°ã€‚
æˆ‘ä»¬å…ˆä»æ•´ä½“ä¸Šçœ‹ä¸€ä¸‹è¿™äº›é’©å­å‡½æ•°æ‰§è¡Œçš„é€»è¾‘ï¼Œé¦–å…ˆæ„é€ ä¸€ä¸ªé˜Ÿåˆ—<code>queue</code>,å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ•°ç»„ï¼›ç„¶åå†å®šä¹‰ä¸€ä¸ªè¿­ä»£å™¨å‡½æ•°<code>iterator</code>;æœ€åå†æ‰§è¡Œ<code>runQueue</code>æ–¹æ³•æ¥æ‰§è¡Œè¿™ä¸ªé˜Ÿåˆ—ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹<code>runQueue</code>çš„å®šä¹‰ï¼Œåœ¨<code>src/util/async.js</code>ä¸­</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">runQueue</span><span class="token punctuation">(</span><span class="token parameter">queue<span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">&gt;</span><span class="token punctuation">,</span>fn<span class="token operator">:</span>Function<span class="token punctuation">,</span>cb<span class="token operator">:</span>Function</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">step</span> <span class="token operator">=</span> <span class="token parameter">index</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fn</span><span class="token punctuation">(</span>queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">step</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">step</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">step</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„å¼‚æ­¥å‡½æ•°é˜Ÿåˆ—åŒ–æ‰§è¡Œçš„æ¨¡å¼ï¼Œ<code>queue</code>æ˜¯ä¸€ä¸ª<code>NavigationGuard</code>ç±»å‹çš„æ•°ç»„ï¼Œæˆ‘ä»¬å®šä¹‰äº†<code>step</code>å‡½æ•°ï¼Œæ¯æ¬¡æ ¹æ®<code>index</code>ä»<code>queue</code>ä¸­å–ä¸€ä¸ª<code>guard</code>,ç„¶åæ‰§è¡Œ<code>fn</code>å‡½æ•°ï¼Œå¹¶ä¸”æŠŠ<code>guard</code>ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå½“è¿™ä¸ªå‡½æ•°æ‰§è¡Œçš„æ—¶å€™å†é€’å½’æ‰§è¡Œ<code>step</code>å‡½æ•°ï¼Œå‰è¿›åˆ°ä¸‹ä¸€ä¸ªï¼Œæ³¨æ„è¿™é‡Œçš„<code>fn</code>å°±æ˜¯æˆ‘ä»¬åˆšæ‰çš„<code>iterator</code>å‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å†å›åˆ°<code>iterator</code>å‡½æ•°çš„å®šä¹‰ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">iterator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">hook<span class="token operator">:</span> NavigationGuard<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">hook</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">to<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>to <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">||</span> <span class="token function">isError</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token function">abort</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
          <span class="token keyword">typeof</span> to<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span>
          <span class="token keyword">typeof</span> to<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'string'</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> to<span class="token punctuation">.</span>replace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">next</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">abort</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>iterator</code>å‡½æ•°é€»è¾‘å¾ˆç®€å•ï¼Œå®ƒå°±æ˜¯å»æ‰§è¡Œæ¯ä¸€ä¸ªå¯¼èˆªå®ˆå«<code>hook</code>ï¼Œå¹¶ä¼ å…¥<code>route</code>ã€<code>current</code>å’ŒåŒ¿åå‡½æ•°ï¼Œè¿™äº›å‚æ•°å¯¹åº”æ–‡æ¡£ä¸­çš„<code>to</code>ã€<code>from</code>ã€<code>next</code>ï¼Œå½“æ‰§è¡Œäº†åŒ¿åå‡½æ•°ï¼Œä¼šæ ¹æ®ä¸€äº›æ¡ä»¶æ‰§è¡Œ<code>abort</code>æˆ–<code>next</code>ï¼Œåªæœ‰æ‰§è¡Œ<code>next</code>çš„æ—¶å€™ï¼Œæ‰ä¼šå‰è¿›åˆ°ä¸‹ä¸€ä¸ªå¯¼èˆªå®ˆå«é’©å­å‡½æ•°ä¸­ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆå®˜æ–¹æ–‡æ¡£ä¼šè¯´åªæœ‰æ‰§è¡Œ<code>next</code>æ–¹æ³•æ¥<code>resolve</code>è¿™ä¸ªé’©å­å‡½æ•°ã€‚
é‚£ä¹ˆæœ€åæˆ‘ä»¬æ¥çœ‹<code>queue</code>æ˜¯æ€ä¹ˆæ„é€ çš„ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> queue<span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
  <span class="token function">extractLeaveGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span>
  <span class="token function">extractUpdateHooks</span><span class="token punctuation">(</span>updated<span class="token punctuation">)</span><span class="token punctuation">,</span>
  activated<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">resolveAsyncComponents</span><span class="token punctuation">(</span>activated<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><p>æŒ‰ç…§é¡ºåºå¦‚ä¸‹ï¼š
1.åœ¨å¤±æ´»çš„ç»„ä»¶é‡Œè°ƒç”¨ç¦»å¼€å®ˆå«ã€‚
2.è°ƒç”¨å…¨å±€çš„<code>beforeEach</code>å®ˆå«ã€‚
3.åœ¨é‡ç”¨çš„ç»„ä»¶é‡Œè°ƒç”¨<code>beforeRouteUpdate</code>å®ˆå«
4.åœ¨æ¿€æ´»çš„è·¯ç”±é…ç½®é‡Œè°ƒç”¨<code>beforeEnter</code>ã€‚
5.è§£æå¼‚æ­¥è·¯ç”±ç»„ä»¶ã€‚
æ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ†åˆ«ä»‹ç»è¿™5æ­¥çš„å®ç°ã€‚
ç¬¬ä¸€æ­¥æ˜¯é€šè¿‡æ‰§è¡Œ<code>extractLeaveGuards(deactivated)</code>ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹<code>extractLeaveGuards</code>çš„å®šä¹‰ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">extractLeaveGuards</span><span class="token punctuation">(</span><span class="token parameter">deactivated<span class="token operator">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span></span><span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>Function<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">extractGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">,</span> <span class="token string">'beforeRouteLeave'</span><span class="token punctuation">,</span> bindGuard<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å®ƒå†…éƒ¨è°ƒç”¨äº†<code>extractGuards</code>çš„é€šç”¨æ–¹æ³•ï¼Œå¯ä»¥ä»<code>RouteRecord</code>æ•°ç»„ä¸­æå–å„ä¸ªé˜¶æ®µçš„å®ˆå«ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">extractGuards</span> <span class="token punctuation">(</span>
  <span class="token parameter">records<span class="token operator">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> string<span class="token punctuation">,</span>
  bind<span class="token operator">:</span> Function<span class="token punctuation">,</span>
  reverse<span class="token operator">?</span><span class="token operator">:</span> boolean</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>Function<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> guards <span class="token operator">=</span> <span class="token function">flatMapComponents</span><span class="token punctuation">(</span>records<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">def<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> guard <span class="token operator">=</span> <span class="token function">extractGuard</span><span class="token punctuation">(</span>def<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>guard<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>guard<span class="token punctuation">)</span>
        <span class="token operator">?</span> guard<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">guard</span> <span class="token operator">=&gt;</span> <span class="token function">bind</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">bind</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">flatten</span><span class="token punctuation">(</span>reverse <span class="token operator">?</span> guards<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> guards<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™é‡Œç”¨åˆ°äº†<code>flatMapComponents</code>æ–¹æ³•å»ä»<code>records</code>ä¸­è·å–æ‰€æœ‰çš„å¯¼èˆªï¼Œå®ƒçš„å®šä¹‰åœ¨<code>src/util/resolve-components.js</code>ä¸­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">flatMapComponents</span> <span class="token punctuation">(</span>
  <span class="token parameter">matched<span class="token operator">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  fn<span class="token operator">:</span> Function</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>Function<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">flatten</span><span class="token punctuation">(</span>matched<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>components<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span>
      m<span class="token punctuation">.</span>components<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>
      m<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>
      m<span class="token punctuation">,</span> key
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">flatten</span> <span class="token punctuation">(</span><span class="token parameter">arr<span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span></span><span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arr<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>flatMapComponents</code>çš„ä½œç”¨å°±æ˜¯è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„çš„å…ƒç´ æ˜¯ä»<code>matched</code>é‡Œè·å–åˆ°æ‰€æœ‰ç»„ä»¶çš„<code>key</code>ï¼Œç„¶åè¿”å›<code>fn</code>å‡½æ•°æ‰§è¡Œçš„ç»“æœï¼Œ<code>flatten</code>ä½œç”¨æ˜¯æŠŠäºŒç»´æ•°ç»„æ‹å¹³æˆä¸€ç»´æ•°ç»„ã€‚
é‚£ä¹ˆå¯¹äº<code>extractGuards</code>ä¸­<code>flatMapComponents</code>çš„è°ƒç”¨ï¼Œæ‰§è¡Œæ¯ä¸ª<code>fn</code>çš„æ—¶å€™ï¼Œé€šè¿‡<code>extractGuard(def,name)</code>è·å–åˆ°ç»„ä»¶ä¸­å¯¹åº”<code>name</code>çš„å¯¼èˆªå®ˆå«ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">extractGuard</span><span class="token punctuation">(</span>
  <span class="token parameter">def<span class="token operator">:</span> Object <span class="token operator">|</span> Function<span class="token punctuation">,</span>
  key<span class="token operator">:</span> string</span>
<span class="token punctuation">)</span><span class="token operator">:</span> NavigationGuard <span class="token operator">|</span> Array<span class="token operator">&lt;</span>NavigationGuard<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> def <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    def <span class="token operator">=</span> _Vue<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>def<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> def<span class="token punctuation">.</span>options<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è·å–åˆ°<code>guard</code>åï¼Œè¿˜ä¼šè°ƒç”¨<code>bind</code>æ–¹æ³•æŠŠç»„ä»¶çš„å®ä¾‹<code>instance</code>ä½œä¸ºå‡½æ•°æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ç»‘å®šåˆ°<code>guard</code>ä¸Šï¼Œ<code>bind</code>æ–¹æ³•çš„å¯¹åº”çš„æ˜¯<code>bindGuard</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">bindGuard</span> <span class="token punctuation">(</span><span class="token parameter">guard<span class="token operator">:</span> NavigationGuard<span class="token punctuation">,</span> instance<span class="token operator">:</span> <span class="token operator">?</span>_Vue</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">?</span>NavigationGuard <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">boundRouteGuard</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">guard</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é‚£ä¹ˆå¯¹äº <code>extractLeaveGuards(deactivated)</code> è€Œè¨€ï¼Œè·å–åˆ°çš„å°±æ˜¯æ‰€æœ‰å¤±æ´»ç»„ä»¶ä¸­å®šä¹‰çš„ <code>beforeRouteLeave</code> é’©å­å‡½æ•°ã€‚
ç¬¬äºŒæ­¥æ˜¯ <code>this.router.beforeHooks</code>ï¼Œåœ¨æˆ‘ä»¬çš„ <code>VueRouter</code> ç±»ä¸­å®šä¹‰äº† <code>beforeEach</code> æ–¹æ³•ï¼Œåœ¨ <code>src/index.js</code> ä¸­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">beforeEach</span> <span class="token punctuation">(</span>fn<span class="token operator">:</span> Function<span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">registerHook</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">registerHook</span> <span class="token punctuation">(</span><span class="token parameter">list<span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">,</span> fn<span class="token operator">:</span> Function</span><span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>
  list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> i <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å½“ç”¨æˆ·ä½¿ç”¨ <code>router.beforeEach</code> æ³¨å†Œäº†ä¸€ä¸ªå…¨å±€å®ˆå«ï¼Œå°±ä¼šå¾€ <code>router.beforeHooks</code> æ·»åŠ ä¸€ä¸ªé’©å­å‡½æ•°ï¼Œè¿™æ · <code>this.router.beforeHooks</code> è·å–çš„å°±æ˜¯ç”¨æˆ·æ³¨å†Œçš„å…¨å±€ <code>beforeEach</code> å®ˆå«ã€‚
ç¬¬ä¸‰æ­¥æ‰§è¡Œäº† <code>extractUpdateHooks(updated)</code>ï¼Œæ¥çœ‹ä¸€ä¸‹ <code>extractUpdateHooks</code> çš„å®šä¹‰ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">extractUpdateHooks</span> <span class="token punctuation">(</span><span class="token parameter">updated<span class="token operator">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span></span><span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>Function<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">extractGuards</span><span class="token punctuation">(</span>updated<span class="token punctuation">,</span> <span class="token string">'beforeRouteUpdate'</span><span class="token punctuation">,</span> bindGuard<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å’Œ <code>extractLeaveGuards(deactivated)</code> ç±»ä¼¼ï¼Œ<code>extractUpdateHooks(updated)</code> è·å–åˆ°çš„å°±æ˜¯æ‰€æœ‰é‡ç”¨çš„ç»„ä»¶ä¸­å®šä¹‰çš„ <code>beforeRouteUpdate</code> é’©å­å‡½æ•°ã€‚
ç¬¬å››æ­¥æ˜¯æ‰§è¡Œ activated.map(m =&gt; m.beforeEnter)ï¼Œè·å–çš„æ˜¯åœ¨æ¿€æ´»çš„è·¯ç”±é…ç½®ä¸­å®šä¹‰çš„ beforeEnter å‡½æ•°ã€‚
ç¬¬äº”æ­¥æ˜¯æ‰§è¡Œ resolveAsyncComponents(activated) è§£æå¼‚æ­¥ç»„ä»¶ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹ resolveAsyncComponents çš„å®šä¹‰ï¼Œåœ¨ src/util/resolve-components.js ä¸­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resolveAsyncComponents</span> <span class="token punctuation">(</span><span class="token parameter">matched<span class="token operator">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span></span><span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> hasAsync <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">let</span> pending <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> error <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token function">flatMapComponents</span><span class="token punctuation">(</span>matched<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">def<span class="token punctuation">,</span> _<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> def <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> def<span class="token punctuation">.</span>cid <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hasAsync <span class="token operator">=</span> <span class="token boolean">true</span>
        pending<span class="token operator">++</span>

        <span class="token keyword">const</span> resolve <span class="token operator">=</span> <span class="token function">once</span><span class="token punctuation">(</span><span class="token parameter">resolvedDef</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isESModule</span><span class="token punctuation">(</span>resolvedDef<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            resolvedDef <span class="token operator">=</span> resolvedDef<span class="token punctuation">.</span>default
          <span class="token punctuation">}</span>
          def<span class="token punctuation">.</span>resolved <span class="token operator">=</span> <span class="token keyword">typeof</span> resolvedDef <span class="token operator">===</span> <span class="token string">'function'</span>
            <span class="token operator">?</span> resolvedDef
            <span class="token operator">:</span> _Vue<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>resolvedDef<span class="token punctuation">)</span>
          match<span class="token punctuation">.</span>components<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> resolvedDef
          pending<span class="token operator">--</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>pending <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">const</span> reject <span class="token operator">=</span> <span class="token function">once</span><span class="token punctuation">(</span><span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to resolve async component </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>reason<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
          process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            error <span class="token operator">=</span> <span class="token function">isError</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>
              <span class="token operator">?</span> reason
              <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
            <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">let</span> res
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          res <span class="token operator">=</span> <span class="token function">def</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> res<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> comp <span class="token operator">=</span> res<span class="token punctuation">.</span>component
            <span class="token keyword">if</span> <span class="token punctuation">(</span>comp <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> comp<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              comp<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasAsync<span class="token punctuation">)</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>resolveAsyncComponents</code> è¿”å›çš„æ˜¯ä¸€ä¸ªå¯¼èˆªå®ˆå«å‡½æ•°ï¼Œæœ‰æ ‡å‡†çš„ <code>to</code>ã€<code>from</code>ã€<code>next</code> å‚æ•°ã€‚å®ƒçš„å†…éƒ¨å®ç°å¾ˆç®€å•ï¼Œåˆ©ç”¨äº† <code>flatMapComponents</code> æ–¹æ³•ä» <code>matched</code> ä¸­è·å–åˆ°æ¯ä¸ªç»„ä»¶çš„å®šä¹‰ï¼Œåˆ¤æ–­å¦‚æœæ˜¯å¼‚æ­¥ç»„ä»¶ï¼Œåˆ™æ‰§è¡Œå¼‚æ­¥ç»„ä»¶åŠ è½½é€»è¾‘ï¼Œè¿™å—å’Œæˆ‘ä»¬ä¹‹å‰åˆ†æ <code>Vue</code> åŠ è½½å¼‚æ­¥ç»„ä»¶å¾ˆç±»ä¼¼ï¼ŒåŠ è½½æˆåŠŸåä¼šæ‰§è¡Œ <code>match.components[key] = resolvedDef</code> æŠŠè§£æå¥½çš„å¼‚æ­¥ç»„ä»¶æ”¾åˆ°å¯¹åº”çš„ <code>components</code> ä¸Šï¼Œå¹¶ä¸”æ‰§è¡Œ <code>next</code> å‡½æ•°ã€‚
è¿™æ ·åœ¨ <code>resolveAsyncComponents(activated)</code> è§£æå®Œæ‰€æœ‰æ¿€æ´»çš„å¼‚æ­¥ç»„ä»¶åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‹¿åˆ°è¿™ä¸€æ¬¡æ‰€æœ‰æ¿€æ´»çš„ç»„ä»¶ã€‚è¿™æ ·æˆ‘ä»¬åœ¨åšå®Œè¿™ 5 æ­¥ååˆåšäº†ä¸€äº›äº‹æƒ…ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> postEnterCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> <span class="token function-variable function">isValid</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">===</span> route
  <span class="token keyword">const</span> enterGuards <span class="token operator">=</span> <span class="token function">extractEnterGuards</span><span class="token punctuation">(</span>activated<span class="token punctuation">,</span> postEnterCbs<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>
  <span class="token keyword">const</span> queue <span class="token operator">=</span> enterGuards<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>resolveHooks<span class="token punctuation">)</span>
  <span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        postEnterCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>6.åœ¨è¢«æ¿€æ´»çš„ç»„ä»¶é‡Œè°ƒç”¨ beforeRouteEnterã€‚
7.è°ƒç”¨å…¨å±€çš„ beforeResolve å®ˆå«ã€‚
8.è°ƒç”¨å…¨å±€çš„ afterEach é’©å­ã€‚</p> <p>å¯¹äºç¬¬å…­æ­¥æœ‰è¿™äº›ç›¸å…³çš„é€»è¾‘</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> postEnterCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> <span class="token function-variable function">isValid</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">===</span> route
<span class="token keyword">const</span> enterGuards <span class="token operator">=</span> <span class="token function">extractEnterGuards</span><span class="token punctuation">(</span>activated<span class="token punctuation">,</span> postEnterCbs<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">extractEnterGuards</span> <span class="token punctuation">(</span>
  activated<span class="token operator">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  cbs<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">isValid</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> boolean
<span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>Function<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">extractGuards</span><span class="token punctuation">(</span>activated<span class="token punctuation">,</span> <span class="token string">'beforeRouteEnter'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">guard<span class="token punctuation">,</span> _<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">bindEnterGuard</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">,</span> cbs<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">bindEnterGuard</span> <span class="token punctuation">(</span>
  guard<span class="token operator">:</span> NavigationGuard<span class="token punctuation">,</span>
  match<span class="token operator">:</span> RouteRecord<span class="token punctuation">,</span>
  key<span class="token operator">:</span> string<span class="token punctuation">,</span>
  cbs<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">isValid</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> boolean
<span class="token punctuation">)</span><span class="token operator">:</span> NavigationGuard <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">routeEnterGuard</span> <span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">guard</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> <span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> cb <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">poll</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> match<span class="token punctuation">.</span>instances<span class="token punctuation">,</span> key<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">poll</span> <span class="token punctuation">(</span>
  cb<span class="token operator">:</span> any<span class="token punctuation">,</span>
  instances<span class="token operator">:</span> Object<span class="token punctuation">,</span>
  key<span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token function-variable function">isValid</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> boolean
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>instances<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cb</span><span class="token punctuation">(</span>instances<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">poll</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> instances<span class="token punctuation">,</span> key<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><code>extractEnterGuards</code> å‡½æ•°çš„å®ç°ä¹Ÿæ˜¯åˆ©ç”¨äº† <code>extractGuards</code> æ–¹æ³•æå–ç»„ä»¶ä¸­çš„ <code>beforeRouteEnter</code> å¯¼èˆªé’©å­å‡½æ•°ï¼Œå’Œä¹‹å‰ä¸åŒçš„æ˜¯ <code>bind</code> æ–¹æ³•çš„ä¸åŒã€‚æ–‡æ¡£ä¸­ç‰¹æ„å¼ºè°ƒäº† <code>beforeRouteEnter</code> é’©å­å‡½æ•°ä¸­æ˜¯æ‹¿ä¸åˆ°ç»„ä»¶å®ä¾‹çš„ï¼Œå› ä¸ºå½“å®ˆå«æ‰§è¡Œå‰ï¼Œç»„ä»¶å®ä¾‹è¿˜æ²¡è¢«åˆ›å»ºï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¼ ä¸€ä¸ªå›è°ƒç»™ <code>next</code> æ¥è®¿é—®ç»„ä»¶å®ä¾‹ã€‚åœ¨å¯¼èˆªè¢«ç¡®è®¤çš„æ—¶å€™æ‰§è¡Œå›è°ƒï¼Œå¹¶ä¸”æŠŠç»„ä»¶å®ä¾‹ä½œä¸ºå›è°ƒæ–¹æ³•çš„å‚æ•°ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">beforeRouteEnter</span> <span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token parameter">vm</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// é€šè¿‡ `vm` è®¿é—®ç»„ä»¶å®ä¾‹</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ¥çœ‹ä¸€ä¸‹è¿™æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p> <p>åœ¨ <code>bindEnterGuard</code> å‡½æ•°ä¸­ï¼Œè¿”å›çš„æ˜¯ <code>routeEnterGuard</code>å‡½æ•°ï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œ <code>iterator</code> ä¸­çš„ <code>hook</code> å‡½æ•°çš„æ—¶å€™ï¼Œå°±ç›¸å½“äºæ‰§è¡Œ <code>routeEnterGuard</code> å‡½æ•°ï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œæˆ‘ä»¬å®šä¹‰çš„å¯¼èˆªå®ˆå« <code>guard</code> å‡½æ•°ï¼Œå¹¶ä¸”å½“è¿™ä¸ªå›è°ƒå‡½æ•°æ‰§è¡Œçš„æ—¶å€™ï¼Œé¦–å…ˆæ‰§è¡Œ next å‡½æ•° rersolve å½“å‰å¯¼èˆªé’©å­ï¼Œç„¶åæŠŠå›è°ƒå‡½æ•°çš„å‚æ•°ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ç”¨ cbs æ”¶é›†èµ·æ¥ï¼Œå…¶å®å°±æ˜¯æ”¶é›†åˆ°å¤–é¢å®šä¹‰çš„ postEnterCbs ä¸­ï¼Œç„¶ååœ¨æœ€åä¼šæ‰§è¡Œï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    postEnterCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨æ ¹è·¯ç”±ç»„ä»¶é‡æ–°æ¸²æŸ“åï¼Œéå† <code>postEnterCbs</code> æ‰§è¡Œå›è°ƒï¼Œæ¯ä¸€ä¸ªå›è°ƒæ‰§è¡Œçš„æ—¶å€™ï¼Œå…¶å®æ˜¯æ‰§è¡Œ <code>poll(cb, match.instances, key, isValid)</code> æ–¹æ³•ï¼Œå› ä¸ºè€ƒè™‘åˆ°ä¸€äº›äº†è·¯ç”±ç»„ä»¶è¢«å¥— <code>transition</code> çµ„ä»¶åœ¨ä¸€äº›ç¼“åŠ¨æ¨¡å¼ä¸‹ä¸ä¸€å®šèƒ½æ‹¿åˆ°å®ä¾‹ï¼Œæ‰€ä»¥ç”¨ä¸€ä¸ªè½®è¯¢æ–¹æ³•ä¸æ–­å»åˆ¤æ–­ï¼Œç›´åˆ°èƒ½è·å–åˆ°ç»„ä»¶å®ä¾‹ï¼Œå†å»è°ƒç”¨ <code>cb</code>ï¼Œå¹¶æŠŠç»„ä»¶å®ä¾‹ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬åœ¨å›è°ƒå‡½æ•°ä¸­èƒ½æ‹¿åˆ°ç»„ä»¶å®ä¾‹çš„åŸå› ã€‚</p> <p>ç¬¬ä¸ƒæ­¥æ˜¯è·å– <code>this.router.resolveHooks</code>ï¼Œè¿™ä¸ªå’Œ <code>this.router.beforeHooks</code> çš„è·å–ç±»ä¼¼ï¼Œåœ¨æˆ‘ä»¬çš„ <code>VueRouter</code> ç±»ä¸­å®šä¹‰äº† <code>beforeResolve</code> æ–¹æ³•ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">beforeResolve</span> <span class="token punctuation">(</span>fn<span class="token operator">:</span> Function<span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">registerHook</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolveHooks<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å½“ç”¨æˆ·ä½¿ç”¨ <code>router.beforeResolve</code> æ³¨å†Œäº†ä¸€ä¸ªå…¨å±€å®ˆå«ï¼Œå°±ä¼šå¾€ <code>router.resolveHooks</code> æ·»åŠ ä¸€ä¸ªé’©å­å‡½æ•°ï¼Œè¿™æ · <code>this.router.resolveHooks</code> è·å–çš„å°±æ˜¯ç”¨æˆ·æ³¨å†Œçš„å…¨å±€ <code>beforeResolve</code> å®ˆå«ã€‚</p> <p>ç¬¬å…«æ­¥æ˜¯åœ¨æœ€åæ‰§è¡Œäº† <code>onComplete(route)</code> åï¼Œä¼šæ‰§è¡Œ <code>this.updateRoute(route)</code> æ–¹æ³•ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">updateRoute</span> <span class="token punctuation">(</span><span class="token parameter">route<span class="token operator">:</span> Route</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> prev <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current
  <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> route
  <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>afterHooks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">hook</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    hook <span class="token operator">&amp;&amp;</span> <span class="token function">hook</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> prev<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åŒæ ·åœ¨æˆ‘ä»¬çš„ <code>VueRouter</code> ç±»ä¸­å®šä¹‰äº† <code>afterEach</code> æ–¹æ³•ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">afterEach</span> <span class="token punctuation">(</span>fn<span class="token operator">:</span> Function<span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">registerHook</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>afterHooks<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å½“ç”¨æˆ·ä½¿ç”¨ <code>router.afterEach</code> æ³¨å†Œäº†ä¸€ä¸ªå…¨å±€å®ˆå«ï¼Œå°±ä¼šå¾€ <code>router.afterHooks</code> æ·»åŠ ä¸€ä¸ªé’©å­å‡½æ•°ï¼Œè¿™æ · <code>this.router.afterHooks</code> è·å–çš„å°±æ˜¯ç”¨æˆ·æ³¨å†Œçš„å…¨å±€ <code>afterHooks</code> å®ˆå«ã€‚</p> <p>é‚£ä¹ˆè‡³æ­¤æˆ‘ä»¬æŠŠæ‰€æœ‰å¯¼èˆªå®ˆå«çš„æ‰§è¡Œåˆ†æå®Œæ¯•äº†ï¼Œæˆ‘ä»¬çŸ¥é“è·¯ç”±åˆ‡æ¢é™¤äº†æ‰§è¡Œè¿™äº›é’©å­å‡½æ•°ï¼Œä»è¡¨è±¡ä¸Šæœ‰ 2 ä¸ªåœ°æ–¹ä¼šå‘ç”Ÿå˜åŒ–ï¼Œä¸€ä¸ªæ˜¯ url å‘ç”Ÿå˜åŒ–ï¼Œä¸€ä¸ªæ˜¯ç»„ä»¶å‘ç”Ÿå˜åŒ–ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†åˆ«ä»‹ç»è¿™ä¸¤å—çš„å®ç°åŸç†ã€‚</p> <h4 id="url">url</h4> <p>å½“æˆ‘ä»¬ç‚¹å‡» <code>router-link</code> çš„æ—¶å€™ï¼Œå®é™…ä¸Šæœ€ç»ˆä¼šæ‰§è¡Œ <code>router.push</code>ï¼Œå¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">push</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> onComplete<span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>this.history.push</code> å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯å­ç±»å®ç°çš„ï¼Œä¸åŒæ¨¡å¼ä¸‹è¯¥å‡½æ•°çš„å®ç°ç•¥æœ‰ä¸åŒï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¹³æ—¶ä½¿ç”¨æ¯”è¾ƒå¤šçš„ <code>hash</code> æ¨¡å¼è¯¥å‡½æ•°çš„å®ç°ï¼Œåœ¨ <code>src/history/hash.js</code> ä¸­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">push</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> current<span class="token operator">:</span> fromRoute <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">pushHash</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>fullPath<span class="token punctuation">)</span>
    <span class="token function">handleScroll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">,</span> route<span class="token punctuation">,</span> fromRoute<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    onComplete <span class="token operator">&amp;&amp;</span> <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>push</code> å‡½æ•°ä¼šå…ˆæ‰§è¡Œ <code>this.transitionTo</code> åšè·¯å¾„åˆ‡æ¢ï¼Œåœ¨åˆ‡æ¢å®Œæˆçš„å›è°ƒå‡½æ•°ä¸­ï¼Œæ‰§è¡Œ <code>pushHash</code> å‡½æ•°ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">pushHash</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsPushState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pushState</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash <span class="token operator">=</span> path
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>supportsPushState</code> çš„å®šä¹‰åœ¨ <code>src/util/push-state.js</code> ä¸­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> supportsPushState <span class="token operator">=</span> inBrowser <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ua <span class="token operator">=</span> window<span class="token punctuation">.</span>navigator<span class="token punctuation">.</span>userAgent

  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span>ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Android 2.'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Android 4.0'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Mobile Safari'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
    ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Chrome'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
    ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Windows Phone'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> window<span class="token punctuation">.</span>history <span class="token operator">&amp;&amp;</span> <span class="token string">'pushState'</span> <span class="token keyword">in</span> window<span class="token punctuation">.</span>history
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>å¦‚æœæ”¯æŒçš„è¯ï¼Œåˆ™è·å–å½“å‰å®Œæ•´çš„ <code>url</code>ï¼Œæ‰§è¡Œ <code>pushState</code> æ–¹æ³•ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">pushState</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">,</span> replace<span class="token operator">?</span><span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">saveScrollPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> history <span class="token operator">=</span> window<span class="token punctuation">.</span>history
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>replace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      history<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token operator">:</span> _key <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      _key <span class="token operator">=</span> <span class="token function">genKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token operator">:</span> _key <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>location<span class="token punctuation">[</span>replace <span class="token operator">?</span> <span class="token string">'replace'</span> <span class="token operator">:</span> <span class="token string">'assign'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>pushState</code> ä¼šè°ƒç”¨æµè§ˆå™¨åŸç”Ÿçš„ <code>history</code> çš„ <code>pushState</code> æ¥å£æˆ–è€… <code>replaceState</code> æ¥å£ï¼Œæ›´æ–°æµè§ˆå™¨çš„ <code>url</code> åœ°å€ï¼Œå¹¶æŠŠå½“å‰ <code>url</code> å‹å…¥å†å²æ ˆä¸­ã€‚</p> <p>ç„¶ååœ¨ <code>history</code> çš„åˆå§‹åŒ–ä¸­ï¼Œä¼šè®¾ç½®ä¸€ä¸ªç›‘å¬å™¨ï¼Œç›‘å¬å†å²æ ˆçš„å˜åŒ–ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setupListeners</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>router
  <span class="token keyword">const</span> expectScroll <span class="token operator">=</span> router<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scrollBehavior
  <span class="token keyword">const</span> supportsScroll <span class="token operator">=</span> supportsPushState <span class="token operator">&amp;&amp;</span> expectScroll

  <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setupScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>supportsPushState <span class="token operator">?</span> <span class="token string">'popstate'</span> <span class="token operator">:</span> <span class="token string">'hashchange'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ensureSlash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span><span class="token function">getHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleScroll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">,</span> route<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>supportsPushState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">replaceHash</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>fullPath<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å½“ç‚¹å‡»æµè§ˆå™¨è¿”å›æŒ‰é’®çš„æ—¶å€™ï¼Œå¦‚æœå·²ç»æœ‰ <code>url</code> è¢«å‹å…¥å†å²æ ˆï¼Œåˆ™ä¼šè§¦å‘ <code>popstate</code> äº‹ä»¶ï¼Œç„¶åæ‹¿åˆ°å½“å‰è¦è·³è½¬çš„ <code>hash</code>ï¼Œæ‰§è¡Œ <code>transtionTo</code> æ–¹æ³•åšä¸€æ¬¡è·¯å¾„è½¬æ¢ã€‚</p> <p>åŒå­¦ä»¬åœ¨ä½¿ç”¨ <code>Vue-Router</code> å¼€å‘é¡¹ç›®çš„æ—¶å€™ï¼Œæ‰“å¼€è°ƒè¯•é¡µé¢ <code>http://localhost:8080</code> åä¼šè‡ªåŠ¨æŠŠ <code>url</code> ä¿®æ”¹ä¸º <code>http://localhost:8080/#/</code>ï¼Œè¿™æ˜¯æ€ä¹ˆåšåˆ°å‘¢ï¼ŸåŸæ¥åœ¨å®ä¾‹åŒ– <code>HashHistory</code> çš„æ—¶å€™ï¼Œæ„é€ å‡½æ•°ä¼šæ‰§è¡Œ <code>ensureSlash()</code> æ–¹æ³•ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">ensureSlash</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">getHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
  <span class="token function">replaceHash</span><span class="token punctuation">(</span><span class="token string">'/'</span> <span class="token operator">+</span> path<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getHash</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token comment">// We can't use window.location.hash here because it's not</span>
  <span class="token comment">// consistent across browsers - Firefox will pre-decode it!</span>
  <span class="token keyword">const</span> href <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href
  <span class="token keyword">const</span> index <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> index <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> href<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getUrl</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> href <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href
  <span class="token keyword">const</span> i <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> base <span class="token operator">=</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> href<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">:</span> href
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>base<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">replaceHash</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsPushState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">replaceState</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">replaceState</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token operator">?</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">pushState</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>è¿™ä¸ªæ—¶å€™ <code>path</code> ä¸ºç©ºï¼Œæ‰€ä»¥æ‰§è¡Œ <code>replaceHash('/' + path)</code>ï¼Œç„¶åå†…éƒ¨ä¼šæ‰§è¡Œä¸€æ¬¡ <code>getUrl</code>ï¼Œè®¡ç®—å‡ºæ¥çš„æ–°çš„ <code>url</code> ä¸º <code>http://localhost:8080/#/</code>ï¼Œæœ€ç»ˆä¼šæ‰§è¡Œ <code>pushState(url, true)</code>ï¼Œè¿™å°±æ˜¯ <code>url</code> ä¼šæ”¹å˜çš„åŸå› ã€‚</p> <h4 id="ç»„ä»¶">ç»„ä»¶</h4> <p>è·¯ç”±æœ€ç»ˆçš„æ¸²æŸ“ç¦»ä¸å¼€ç»„ä»¶ï¼ŒVue-Routerå†…ç½®äº†<code>&lt;router-view&gt;</code>ç»„ä»¶ï¼Œå®ƒçš„å®šä¹‰åœ¨<code>src/components/view.js</code>ä¸­ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'RouterView'</span><span class="token punctuation">,</span>
  functional<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> String<span class="token punctuation">,</span>
      <span class="token keyword">default</span><span class="token operator">:</span> <span class="token string">'default'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> <span class="token punctuation">{</span> props<span class="token punctuation">,</span> children<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data<span class="token punctuation">.</span>routerView <span class="token operator">=</span> <span class="token boolean">true</span>
   
    <span class="token keyword">const</span> h <span class="token operator">=</span> parent<span class="token punctuation">.</span>$createElement
    <span class="token keyword">const</span> name <span class="token operator">=</span> props<span class="token punctuation">.</span>name
    <span class="token keyword">const</span> route <span class="token operator">=</span> parent<span class="token punctuation">.</span>$route
    <span class="token keyword">const</span> cache <span class="token operator">=</span> parent<span class="token punctuation">.</span>_routerViewCache <span class="token operator">||</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span>_routerViewCache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">let</span> depth <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> inactive <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>_routerRoot <span class="token operator">!==</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span>$vnode <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>$vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>routerView<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        depth<span class="token operator">++</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span>_inactive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        inactive <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
      parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>$parent
    <span class="token punctuation">}</span>
    data<span class="token punctuation">.</span>routerViewDepth <span class="token operator">=</span> depth

    <span class="token keyword">if</span> <span class="token punctuation">(</span>inactive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>cache<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> matched <span class="token operator">=</span> route<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>depth<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cache<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> component <span class="token operator">=</span> cache<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> matched<span class="token punctuation">.</span>components<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
   
    data<span class="token punctuation">.</span><span class="token function-variable function">registerRouteInstance</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>     
      <span class="token keyword">const</span> current <span class="token operator">=</span> matched<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token punctuation">(</span>val <span class="token operator">&amp;&amp;</span> current <span class="token operator">!==</span> vm<span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span><span class="token operator">!</span>val <span class="token operator">&amp;&amp;</span> current <span class="token operator">===</span> vm<span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        matched<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> val
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token punctuation">;</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>hook <span class="token operator">||</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>hook <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">prepatch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      matched<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentInstance
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> propsToPass <span class="token operator">=</span> data<span class="token punctuation">.</span>props <span class="token operator">=</span> <span class="token function">resolveProps</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> matched<span class="token punctuation">.</span>props <span class="token operator">&amp;&amp;</span> matched<span class="token punctuation">.</span>props<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>propsToPass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      propsToPass <span class="token operator">=</span> data<span class="token punctuation">.</span>props <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> propsToPass<span class="token punctuation">)</span>
      <span class="token keyword">const</span> attrs <span class="token operator">=</span> data<span class="token punctuation">.</span>attrs <span class="token operator">=</span> data<span class="token punctuation">.</span>attrs <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> propsToPass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>component<span class="token punctuation">.</span>props <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> component<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          attrs<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> propsToPass<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
          <span class="token keyword">delete</span> propsToPass<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>component<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>&lt;router-view&gt;</code> æ˜¯ä¸€ä¸ª <code>functional</code> ç»„ä»¶ï¼Œå®ƒçš„æ¸²æŸ“ä¹Ÿæ˜¯ä¾èµ– render å‡½æ•°ï¼Œé‚£ä¹ˆ <code>&lt;router-view&gt;</code> å…·ä½“åº”è¯¥æ¸²æŸ“ä»€ä¹ˆç»„ä»¶å‘¢ï¼Œé¦–å…ˆè·å–å½“å‰çš„è·¯å¾„ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> route <span class="token operator">=</span> parent<span class="token punctuation">.</span>$route
</code></pre></div><p>æˆ‘ä»¬ä¹‹å‰åˆ†æè¿‡ï¼Œåœ¨ <code>src/install.js</code> ä¸­ï¼Œæˆ‘ä»¬ç»™ <code>Vue</code> çš„åŸå‹ä¸Šå®šä¹‰äº† <code>$route</code>ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'$route'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot<span class="token punctuation">.</span>_route <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>ç„¶ååœ¨ <code>VueRouter</code> çš„å®ä¾‹æ‰§è¡Œ <code>router.init</code> æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œå¦‚ä¸‹é€»è¾‘ï¼Œå®šä¹‰åœ¨ <code>src/index.js</code> ä¸­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code>history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span>_route <span class="token operator">=</span> route
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>è€Œ <code>history.listen</code> æ–¹æ³•å®šä¹‰åœ¨ <code>src/history/base.js</code> ä¸­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">listen</span> <span class="token punctuation">(</span><span class="token parameter">cb<span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb
<span class="token punctuation">}</span>
</code></pre></div><p>ç„¶ååœ¨ <code>updateRoute</code> çš„æ—¶å€™æ‰§è¡Œ <code>this.cb</code>ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">updateRoute</span> <span class="token punctuation">(</span><span class="token parameter">route<span class="token operator">:</span> Route</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//. ..</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> route
  <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰§è¡Œ <code>transitionTo</code> æ–¹æ³•æœ€åæ‰§è¡Œ <code>updateRoute</code> çš„æ—¶å€™ä¼šæ‰§è¡Œå›è°ƒï¼Œç„¶åä¼šæ›´æ–° <code>this.apps</code> ä¿å­˜çš„ç»„ä»¶å®ä¾‹çš„ <code>_route</code> å€¼ï¼Œ<code>this.apps</code> æ•°ç»„ä¿å­˜çš„å®ä¾‹çš„ç‰¹ç‚¹éƒ½æ˜¯åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼ å…¥äº† <code>router</code> é…ç½®é¡¹ï¼Œä¸€èˆ¬çš„åœºæ™¯æ•°ç»„åªä¼šä¿å­˜æ ¹ Vue å®ä¾‹ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯åœ¨ <code>new Vue</code> ä¼ å…¥äº† <code>router</code> å®ä¾‹ã€‚<code>$route</code> æ˜¯å®šä¹‰åœ¨ <code>Vue.prototype</code> ä¸Šã€‚æ¯ä¸ªç»„ä»¶å®ä¾‹è®¿é—® <code>$route</code> å±æ€§ï¼Œå°±æ˜¯è®¿é—®æ ¹å®ä¾‹çš„ <code>_route</code>ï¼Œä¹Ÿå°±æ˜¯å½“å‰çš„è·¯ç”±çº¿è·¯ã€‚</p> <p><code>&lt;router-view&gt;</code> æ˜¯æ”¯æŒåµŒå¥—çš„ï¼Œå›åˆ° <code>render</code> å‡½æ•°ï¼Œå…¶ä¸­å®šä¹‰äº† <code>depth</code> çš„æ¦‚å¿µï¼Œå®ƒè¡¨ç¤º <code>&lt;router-view&gt;</code> åµŒå¥—çš„æ·±åº¦ã€‚æ¯ä¸ª <code>&lt;router-view&gt;</code> åœ¨æ¸²æŸ“çš„æ—¶å€™ï¼Œæ‰§è¡Œå¦‚ä¸‹é€»è¾‘ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code>data<span class="token punctuation">.</span>routerView <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token comment">// ...</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>_routerRoot <span class="token operator">!==</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span>$vnode <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>$vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>routerView<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depth<span class="token operator">++</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span>_inactive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    inactive <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
  parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>$parent
<span class="token punctuation">}</span>

<span class="token keyword">const</span> matched <span class="token operator">=</span> route<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>depth<span class="token punctuation">]</span>
<span class="token comment">// ...</span>
<span class="token keyword">const</span> component <span class="token operator">=</span> cache<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> matched<span class="token punctuation">.</span>components<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
</code></pre></div><p><code>parent._routerRoot</code> è¡¨ç¤ºçš„æ˜¯æ ¹ Vue å®ä¾‹ï¼Œé‚£ä¹ˆè¿™ä¸ªå¾ªç¯å°±æ˜¯ä»å½“å‰çš„ <code>&lt;router-view&gt;</code> çš„çˆ¶èŠ‚ç‚¹å‘ä¸Šæ‰¾ï¼Œä¸€ç›´æ‰¾åˆ°æ ¹ Vue å®ä¾‹ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ï¼Œå¦‚æœç¢°åˆ°äº†çˆ¶èŠ‚ç‚¹ä¹Ÿæ˜¯ <code>&lt;router-view&gt;</code> çš„æ—¶å€™ï¼Œè¯´æ˜ <code>&lt;router-view&gt;</code> æœ‰åµŒå¥—çš„æƒ…å†µï¼Œ<code>depth++</code>ã€‚éå†å®Œæˆåï¼Œæ ¹æ®å½“å‰çº¿è·¯åŒ¹é…çš„è·¯å¾„å’Œ <code>depth</code> æ‰¾åˆ°å¯¹åº”çš„ <code>RouteRecord</code>ï¼Œè¿›è€Œæ‰¾åˆ°è¯¥æ¸²æŸ“çš„ç»„ä»¶ã€‚</p> <p>é™¤äº†æ‰¾åˆ°äº†åº”è¯¥æ¸²æŸ“çš„ç»„ä»¶ï¼Œè¿˜å®šä¹‰äº†ä¸€ä¸ªæ³¨å†Œè·¯ç”±å®ä¾‹çš„æ–¹æ³•ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code>data<span class="token punctuation">.</span><span class="token function-variable function">registerRouteInstance</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>     
  <span class="token keyword">const</span> current <span class="token operator">=</span> matched<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span>val <span class="token operator">&amp;&amp;</span> current <span class="token operator">!==</span> vm<span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token punctuation">(</span><span class="token operator">!</span>val <span class="token operator">&amp;&amp;</span> current <span class="token operator">===</span> vm<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    matched<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> val
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç»™ <code>vnode</code> çš„ <code>data</code> å®šä¹‰äº† <code>registerRouteInstance</code> æ–¹æ³•ï¼Œåœ¨ <code>src/install.js</code> ä¸­ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨è¯¥æ–¹æ³•å»æ³¨å†Œè·¯ç”±çš„å®ä¾‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">registerInstance</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> callVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_parentVnode
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>registerRouteInstance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">i</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> callVal<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">beforeCreate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">destroyed</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>åœ¨æ··å…¥çš„ <code>beforeCreate</code> é’©å­å‡½æ•°ä¸­ï¼Œä¼šæ‰§è¡Œ <code>registerInstance</code> æ–¹æ³•ï¼Œè¿›è€Œæ‰§è¡Œ <code>render</code> å‡½æ•°ä¸­å®šä¹‰çš„ <code>registerRouteInstance</code> æ–¹æ³•ï¼Œä»è€Œç»™ <code>matched.instances[name]</code> èµ‹å€¼å½“å‰ç»„ä»¶çš„ vm å®ä¾‹ã€‚</p> <p><code>render</code> å‡½æ•°çš„æœ€åæ ¹æ® <code>component</code> æ¸²æŸ“å‡ºå¯¹åº”çš„ç»„ä»¶ <code>vonde</code>ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>component<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
</code></pre></div><p>é‚£ä¹ˆå½“æˆ‘ä»¬æ‰§è¡Œ <code>transitionTo</code> æ¥æ›´æ”¹è·¯ç”±çº¿è·¯åï¼Œç»„ä»¶æ˜¯å¦‚ä½•é‡æ–°æ¸²æŸ“çš„å‘¢ï¼Ÿåœ¨æˆ‘ä»¬æ··å…¥çš„ <code>beforeCreate</code> é’©å­å‡½æ•°ä¸­æœ‰è¿™ä¹ˆä¸€æ®µé€»è¾‘ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code>Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">beforeCreate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Vue<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'_route'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span>history<span class="token punctuation">.</span>current<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>ç”±äºæˆ‘ä»¬æŠŠæ ¹ Vue å®ä¾‹çš„ <code>_route</code> å±æ€§å®šä¹‰æˆå“åº”å¼çš„ï¼Œæˆ‘ä»¬åœ¨æ¯ä¸ª <code>&lt;router-view&gt;</code> æ‰§è¡Œ <code>render</code> å‡½æ•°çš„æ—¶å€™ï¼Œéƒ½ä¼šè®¿é—® <code>parent.$route</code>ï¼Œå¦‚æˆ‘ä»¬ä¹‹å‰åˆ†æä¼šè®¿é—® <code>this._routerRoot._route</code>ï¼Œè§¦å‘äº†å®ƒçš„ <code>getter</code>ï¼Œç›¸å½“äº <code>&lt;router-view&gt;</code> å¯¹å®ƒæœ‰ä¾èµ–ï¼Œç„¶åå†æ‰§è¡Œå®Œ <code>transitionTo</code> åï¼Œä¿®æ”¹ <code>app._route</code> çš„æ—¶å€™ï¼Œåˆè§¦å‘äº†<code>setter</code>ï¼Œå› æ­¤ä¼šé€šçŸ¥ <code>&lt;router-view&gt;</code> çš„æ¸²æŸ“ <code>watcher</code> æ›´æ–°ï¼Œé‡æ–°æ¸²æŸ“ç»„ä»¶ã€‚
<code>Vue-Router</code> è¿˜å†…ç½®äº†å¦ä¸€ä¸ªç»„ä»¶ <code>&lt;router-link&gt;</code>ï¼Œ å®ƒæ”¯æŒç”¨æˆ·åœ¨å…·æœ‰è·¯ç”±åŠŸèƒ½çš„åº”ç”¨ä¸­ï¼ˆç‚¹å‡»ï¼‰å¯¼èˆªã€‚ é€šè¿‡ <code>to</code> å±æ€§æŒ‡å®šç›®æ ‡åœ°å€ï¼Œé»˜è®¤æ¸²æŸ“æˆå¸¦æœ‰æ­£ç¡®é“¾æ¥çš„ <code>&lt;a&gt;</code> æ ‡ç­¾ï¼Œå¯ä»¥é€šè¿‡é…ç½® <code>tag</code> å±æ€§ç”Ÿæˆåˆ«çš„æ ‡ç­¾ã€‚å¦å¤–ï¼Œå½“ç›®æ ‡è·¯ç”±æˆåŠŸæ¿€æ´»æ—¶ï¼Œé“¾æ¥å…ƒç´ è‡ªåŠ¨è®¾ç½®ä¸€ä¸ªè¡¨ç¤ºæ¿€æ´»çš„ CSS ç±»åã€‚
<code>&lt;router-link&gt;</code> æ¯”èµ·å†™æ­»çš„ <code>&lt;a href=&quot;...&quot;&gt;</code> ä¼šå¥½ä¸€äº›ï¼Œç†ç”±å¦‚ä¸‹ï¼š
æ— è®ºæ˜¯ <code>HTML5 history</code> æ¨¡å¼è¿˜æ˜¯ <code>hash</code> æ¨¡å¼ï¼Œå®ƒçš„è¡¨ç°è¡Œä¸ºä¸€è‡´ï¼Œæ‰€ä»¥ï¼Œå½“ä½ è¦åˆ‡æ¢è·¯ç”±æ¨¡å¼ï¼Œæˆ–è€…åœ¨ <code>IE9</code> é™çº§ä½¿ç”¨ <code>hash</code> æ¨¡å¼ï¼Œæ— é¡»ä½œä»»ä½•å˜åŠ¨ã€‚
åœ¨ <code>HTML5 history</code> æ¨¡å¼ä¸‹ï¼Œ<code>router-link</code> ä¼šå®ˆå«ç‚¹å‡»äº‹ä»¶ï¼Œè®©æµè§ˆå™¨ä¸å†é‡æ–°åŠ è½½é¡µé¢ã€‚
å½“ä½ åœ¨ <code>HTML5 history</code> æ¨¡å¼ä¸‹ä½¿ç”¨ <code>base</code> é€‰é¡¹ä¹‹åï¼Œæ‰€æœ‰çš„ <code>to</code> å±æ€§éƒ½ä¸éœ€è¦å†™ï¼ˆåŸºè·¯å¾„ï¼‰äº†ã€‚
é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥åˆ†æå®ƒçš„å®ç°ï¼Œå®ƒçš„å®šä¹‰åœ¨ <code>src/components/link.js</code> ä¸­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'RouterLink'</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    to<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> toTypes<span class="token punctuation">,</span>
      required<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    tag<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> String<span class="token punctuation">,</span>
      <span class="token keyword">default</span><span class="token operator">:</span> <span class="token string">'a'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    exact<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
    append<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
    replace<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
    activeClass<span class="token operator">:</span> String<span class="token punctuation">,</span>
    exactActiveClass<span class="token operator">:</span> String<span class="token punctuation">,</span>
    event<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> eventTypes<span class="token punctuation">,</span>
      <span class="token keyword">default</span><span class="token operator">:</span> <span class="token string">'click'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">h<span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$router
    <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$route
    <span class="token keyword">const</span> <span class="token punctuation">{</span> location<span class="token punctuation">,</span> route<span class="token punctuation">,</span> href <span class="token punctuation">}</span> <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>to<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>append<span class="token punctuation">)</span>

    <span class="token keyword">const</span> classes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">const</span> globalActiveClass <span class="token operator">=</span> router<span class="token punctuation">.</span>options<span class="token punctuation">.</span>linkActiveClass
    <span class="token keyword">const</span> globalExactActiveClass <span class="token operator">=</span> router<span class="token punctuation">.</span>options<span class="token punctuation">.</span>linkExactActiveClass
    <span class="token keyword">const</span> activeClassFallback <span class="token operator">=</span> globalActiveClass <span class="token operator">==</span> <span class="token keyword">null</span>
            <span class="token operator">?</span> <span class="token string">'router-link-active'</span>
            <span class="token operator">:</span> globalActiveClass
    <span class="token keyword">const</span> exactActiveClassFallback <span class="token operator">=</span> globalExactActiveClass <span class="token operator">==</span> <span class="token keyword">null</span>
            <span class="token operator">?</span> <span class="token string">'router-link-exact-active'</span>
            <span class="token operator">:</span> globalExactActiveClass
    <span class="token keyword">const</span> activeClass <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>activeClass <span class="token operator">==</span> <span class="token keyword">null</span>
            <span class="token operator">?</span> activeClassFallback
            <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>activeClass
    <span class="token keyword">const</span> exactActiveClass <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>exactActiveClass <span class="token operator">==</span> <span class="token keyword">null</span>
            <span class="token operator">?</span> exactActiveClassFallback
            <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>exactActiveClass
    <span class="token keyword">const</span> compareTarget <span class="token operator">=</span> location<span class="token punctuation">.</span>path
      <span class="token operator">?</span> <span class="token function">createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> location<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> router<span class="token punctuation">)</span>
      <span class="token operator">:</span> route

    classes<span class="token punctuation">[</span>exactActiveClass<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">isSameRoute</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> compareTarget<span class="token punctuation">)</span>
    classes<span class="token punctuation">[</span>activeClass<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>exact
      <span class="token operator">?</span> classes<span class="token punctuation">[</span>exactActiveClass<span class="token punctuation">]</span>
      <span class="token operator">:</span> <span class="token function">isIncludedRoute</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> compareTarget<span class="token punctuation">)</span>

    <span class="token keyword">const</span> <span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">guardEvent</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>replace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          router<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> on <span class="token operator">=</span> <span class="token punctuation">{</span> click<span class="token operator">:</span> guardEvent <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>event<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> on<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">=</span> handler <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      on<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>event<span class="token punctuation">]</span> <span class="token operator">=</span> handler
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> data<span class="token operator">:</span> any <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token keyword">class</span><span class="token operator">:</span> classes
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      data<span class="token punctuation">.</span>on <span class="token operator">=</span> on
      data<span class="token punctuation">.</span>attrs <span class="token operator">=</span> <span class="token punctuation">{</span> href <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token function">findAnchor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        a<span class="token punctuation">.</span>isStatic <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">const</span> extend <span class="token operator">=</span> _Vue<span class="token punctuation">.</span>util<span class="token punctuation">.</span>extend
        <span class="token keyword">const</span> aData <span class="token operator">=</span> a<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
        aData<span class="token punctuation">.</span>on <span class="token operator">=</span> on
        <span class="token keyword">const</span> aAttrs <span class="token operator">=</span> a<span class="token punctuation">.</span>data<span class="token punctuation">.</span>attrs <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>data<span class="token punctuation">.</span>attrs<span class="token punctuation">)</span>
        aAttrs<span class="token punctuation">.</span>href <span class="token operator">=</span> href
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">.</span>on <span class="token operator">=</span> on
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>&lt;router-link&gt;</code> æ ‡ç­¾çš„æ¸²æŸ“ä¹Ÿæ˜¯åŸºäº <code>render</code> å‡½æ•°ï¼Œå®ƒé¦–å…ˆåšäº†è·¯ç”±è§£æï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$router
<span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$route
<span class="token keyword">const</span> <span class="token punctuation">{</span> location<span class="token punctuation">,</span> route<span class="token punctuation">,</span> href <span class="token punctuation">}</span> <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>to<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>append<span class="token punctuation">)</span>
</code></pre></div><p><code>router.resolve</code> æ˜¯ <code>VueRouter</code> çš„å®ä¾‹æ–¹æ³•ï¼Œå®ƒçš„å®šä¹‰åœ¨ <code>src/index.js</code> ä¸­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">resolve</span> <span class="token punctuation">(</span>
  to<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span>
  current<span class="token operator">?</span><span class="token operator">:</span> Route<span class="token punctuation">,</span>
  append<span class="token operator">?</span><span class="token operator">:</span> boolean
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  location<span class="token operator">:</span> Location<span class="token punctuation">,</span>
  route<span class="token operator">:</span> Route<span class="token punctuation">,</span>
  href<span class="token operator">:</span> string<span class="token punctuation">,</span>
  normalizedTo<span class="token operator">:</span> Location<span class="token punctuation">,</span>
  resolved<span class="token operator">:</span> Route
<span class="token punctuation">}</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">normalizeLocation</span><span class="token punctuation">(</span>
    to<span class="token punctuation">,</span>
    current <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span>current<span class="token punctuation">,</span>
    append<span class="token punctuation">,</span>
    <span class="token keyword">this</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> current<span class="token punctuation">)</span>
  <span class="token keyword">const</span> fullPath <span class="token operator">=</span> route<span class="token punctuation">.</span>redirectedFrom <span class="token operator">||</span> route<span class="token punctuation">.</span>fullPath
  <span class="token keyword">const</span> base <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span>base
  <span class="token keyword">const</span> href <span class="token operator">=</span> <span class="token function">createHref</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> fullPath<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mode<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    location<span class="token punctuation">,</span>
    route<span class="token punctuation">,</span>
    href<span class="token punctuation">,</span>
    normalizedTo<span class="token operator">:</span> location<span class="token punctuation">,</span>
    resolved<span class="token operator">:</span> route
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createHref</span> <span class="token punctuation">(</span><span class="token parameter">base<span class="token operator">:</span> string<span class="token punctuation">,</span> fullPath<span class="token operator">:</span> string<span class="token punctuation">,</span> mode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> path <span class="token operator">=</span> mode <span class="token operator">===</span> <span class="token string">'hash'</span> <span class="token operator">?</span> <span class="token string">'#'</span> <span class="token operator">+</span> fullPath <span class="token operator">:</span> fullPath
  <span class="token keyword">return</span> base <span class="token operator">?</span> <span class="token function">cleanPath</span><span class="token punctuation">(</span>base <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> path<span class="token punctuation">)</span> <span class="token operator">:</span> path
<span class="token punctuation">}</span>
</code></pre></div><p>å®ƒå…ˆè§„èŒƒç”Ÿæˆç›®æ ‡ <code>location</code>ï¼Œå†æ ¹æ® <code>location</code> å’Œ <code>match</code> é€šè¿‡ <code>this.match</code> æ–¹æ³•è®¡ç®—ç”Ÿæˆç›®æ ‡è·¯å¾„ <code>route</code>ï¼Œç„¶åå†æ ¹æ® <code>base</code>ã€<code>fullPath</code> å’Œ <code>this.mode</code> é€šè¿‡ <code>createHref</code> æ–¹æ³•è®¡ç®—å‡ºæœ€ç»ˆè·³è½¬çš„ <code>href</code>ã€‚
è§£æå®Œ <code>router</code> è·å¾—ç›®æ ‡ <code>location</code>ã€<code>route</code>ã€<code>href</code> åï¼Œæ¥ä¸‹æ¥å¯¹ <code>exactActiveClass</code> å’Œ <code>activeClass</code> åšå¤„ç†ï¼Œå½“é…ç½® <code>exact</code> ä¸º <code>true</code> çš„æ—¶å€™ï¼Œåªæœ‰å½“ç›®æ ‡è·¯å¾„å’Œå½“å‰è·¯å¾„å®Œå…¨åŒ¹é…çš„æ—¶å€™ï¼Œä¼šæ·»åŠ  <code>exactActiveClass</code>ï¼›è€Œå½“ç›®æ ‡è·¯å¾„åŒ…å«å½“å‰è·¯å¾„çš„æ—¶å€™ï¼Œä¼šæ·»åŠ  <code>activeClass</code>ã€‚
æ¥ç€åˆ›å»ºäº†ä¸€ä¸ªå®ˆå«å‡½æ•° ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">guardEvent</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>replace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      router<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">guardEvent</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>metaKey <span class="token operator">||</span> e<span class="token punctuation">.</span>altKey <span class="token operator">||</span> e<span class="token punctuation">.</span>ctrlKey <span class="token operator">||</span> e<span class="token punctuation">.</span>shiftKey<span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>defaultPrevented<span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>button <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>button <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> 
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>currentTarget <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>currentTarget<span class="token punctuation">.</span>getAttribute<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> e<span class="token punctuation">.</span>currentTarget<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'target'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/\b_blank\b/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>preventDefault<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> on <span class="token operator">=</span> <span class="token punctuation">{</span> click<span class="token operator">:</span> guardEvent <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>event<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> on<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">=</span> handler <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    on<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>event<span class="token punctuation">]</span> <span class="token operator">=</span> handler
  <span class="token punctuation">}</span>
</code></pre></div><p>æœ€ç»ˆä¼šç›‘å¬ç‚¹å‡»äº‹ä»¶æˆ–è€…å…¶å®ƒå¯ä»¥é€šè¿‡ <code>prop</code> ä¼ å…¥çš„äº‹ä»¶ç±»å‹ï¼Œæ‰§è¡Œ <code>hanlder</code> å‡½æ•°ï¼Œæœ€ç»ˆæ‰§è¡Œ <code>router.push</code> æˆ–è€… <code>router.replace</code> å‡½æ•°ï¼Œå®ƒä»¬çš„å®šä¹‰åœ¨ <code>src/index.js</code> ä¸­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">push</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> onComplete<span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">replace</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> onComplete<span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å®é™…ä¸Šå°±æ˜¯æ‰§è¡Œäº† <code>history</code> çš„ <code>push</code> å’Œ <code>replace</code> æ–¹æ³•åšè·¯ç”±è·³è½¬ã€‚
æœ€ååˆ¤æ–­å½“å‰ <code>tag</code> æ˜¯å¦æ˜¯ <code>&lt;a&gt;</code> æ ‡ç­¾ï¼Œ<code>&lt;router-link&gt;</code> é»˜è®¤ä¼šæ¸²æŸ“æˆ <code>&lt;a&gt;</code> æ ‡ç­¾ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¿®æ”¹ <code>tag</code> çš„ <code>prop</code> æ¸²æŸ“æˆå…¶ä»–èŠ‚ç‚¹ï¼Œè¿™ç§æƒ…å†µä¸‹ä¼šå°è¯•æ‰¾å®ƒå­å…ƒç´ çš„ <code>&lt;a&gt;</code> æ ‡ç­¾ï¼Œå¦‚æœæœ‰åˆ™æŠŠäº‹ä»¶ç»‘å®šåˆ° <code>&lt;a&gt;</code> æ ‡ç­¾ä¸Šå¹¶æ·»åŠ  <code>href</code> å±æ€§ï¼Œå¦åˆ™ç»‘å®šåˆ°å¤–å±‚å…ƒç´ æœ¬èº«ã€‚</p> <h3 id="è¿‡ç¨‹">è¿‡ç¨‹</h3> <p>æˆ‘ä»¬åˆ›å»ºçš„è·¯ç”±éƒ½æ˜¯VueRouterç±»çš„å®ä¾‹åŒ–ï¼Œç”¨æ¥ç®¡ç†æˆ‘ä»¬çš„<code>ã€key-components-viewã€‘</code>,ä¸€ä¸ªkeyï¼ˆä»£ç ä¸­çš„pathï¼‰å¯¹åº”ä¸€ä¸ªç»„ä»¶ï¼Œviewä¹Ÿå°±æ˜¯<code>&lt;router-view&gt;</code>åœ¨templateé‡Œé¢å ä¸ªå‘ï¼Œç”¨æ¥æ ¹æ®keyå±•ç¤ºå¯¹åº”çš„ç»„ä»¶ï¼Œå®é™…ä¸Šçš„funcè®©æˆ‘ä»¬å¯ä»¥æ§åˆ¶è·¯ç”±ï¼Œä¹Ÿå°±æ˜¯å®˜ç½‘çš„api
è¯´ç®€å•ç‚¹ï¼Œè·¯ç”±å°±æ˜¯ä¸€ä¸ªè½®æ’­å›¾ï¼Œå†™ä¸ªå¾ªç¯åˆ‡æ¢keyçš„funcå°±æ˜¯è½®æ’­äº†ï¼Œè€Œkeyå°±æ˜¯è½®æ’­çš„indexï¼Œæ‰‹åŠ¨æ»‘ã€‚é‚£ä¹ˆï¼Œ<code>vue-router</code>æ˜¯å¦‚ä½•å®ç°ä¸å‘é€è¯·æ±‚å°±æ›´æ–°è§†å›¾çš„å‘¢</p> <h3 id="routerå·¥ä½œåŸç†">routerå·¥ä½œåŸç†</h3> <p>å¦‚æœä½ è¦ä½¿ç”¨åˆ°routerï¼Œä½ ä¼šåœ¨å®ä¾‹åŒ–Vueçš„å‚æ•°optionsä¸­åŠ å…¥router
é‚£ï¼ŒVueæ˜¯å¦‚ä½•ä½¿ç”¨è¿™ä¸ªå‚æ•°å‘¢ï¼Œvue-routeræ˜¯ä½œä¸ºæ’ä»¶åŠ å…¥ä½¿ç”¨çš„ï¼Œé€šè¿‡mixinï¼ˆæ··åˆï¼‰æ¥å½±å“æ¯ä¸€ä¸ªVueå®ä¾‹åŒ–ï¼Œåœ¨beforeCreateé’©å­çš„æ—¶å€™å°±ä¼šå®Œæˆrouterçš„åˆå§‹åŒ–ï¼Œä»å‚æ•°è·å–router&gt;è°ƒç”¨initåˆå§‹åŒ–&gt;åŠ å…¥å“åº”å¼ï¼ˆdefineReactiveæ–¹æ³•åœ¨Vueæºç ç”¨çš„å¾ˆå¤šï¼Œä¹Ÿæ˜¯åº•å±‚å®ç°å“åº”å¼çš„æ ¸å¿ƒæ–¹æ³•ï¼‰
åˆå§‹åŒ–ä¼šåšäº›ä»€ä¹ˆï¼š
åˆ¤æ–­ä¸»ç¨‹åºçŠ¶æ€ï¼ˆå·²ç»åˆå§‹åŒ–äº†çš„Vueå®ä¾‹ä¸ä¼šå†é‡æ–°åˆå§‹åŒ–è·¯ç”±ï¼Œä¹Ÿå°±æ˜¯ä½ ä¸èƒ½æ‰‹åŠ¨å»å†initä¸€æ¬¡ï¼‰
æŠŠå®ä¾‹åŠ å…¥å†…ç½®æ•°ç»„
åˆ¤æ–­historyçš„ç±»å‹ï¼Œåšä¸€äº›ç±»ä¼¼ä¼˜åŒ–çš„äº‹ï¼Œæ¯”å¦‚hashæ¨¡å¼çš„setupListenersæ–¹æ³•ï¼Œå°±æ˜¯å»¶è¿Ÿç›‘å¬hashChangeäº‹ä»¶ï¼Œç­‰åˆ°vueå®ŒæˆæŒ‚è½½å†ç›‘å¬
listenå®šä¹‰ä¸€ä¸ªcallbackï¼Œlistenæ˜¯å®šä¹‰åœ¨æœ€åº•å±‚Historyç±»ä¸Šçš„ï¼Œä½œç”¨å°±æ˜¯å®šä¹‰ä¸€ä¸ªcallbackï¼Œlistenä¼šåœ¨éœ€è¦çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œåœ¨è·¯ç”±å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ä¼šæ‰§è¡Œè¿™ä¸ªcallback</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">VueRouter</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token function">init</span> <span class="token punctuation">(</span><span class="token parameter">app<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">assert</span><span class="token punctuation">(</span>
      install<span class="token punctuation">.</span>installed<span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">not installed. Make sure to call \`Vue.use(VueRouter)\` </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">before creating root instance.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
    <span class="token comment">// è¿™ä¸ªappså­˜å‚¨äº†è®©æ‰€æœ‰çš„Vueå®ä¾‹åŒ–ï¼ˆæ ¹ç»„ä»¶ï¼‰ï¼Œåé¢éå†çš„æ—¶å€™ï¼Œä¼šæŠŠå½“å‰æ ‡è®°routeæŒ‚åˆ°æ‰€æœ‰æ ¹ç»„ä»¶çš„ï¼Œä¹Ÿå°±æ˜¯vm._routeä¹Ÿæ˜¯</span>
    <span class="token comment">// vm._router.history.current</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>  
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> app
    <span class="token keyword">const</span> history <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history
    <span class="token keyword">if</span><span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HTML5History</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HashHistory</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token function-variable function">setupHashListener</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        history<span class="token punctuation">.</span><span class="token function">setupListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>
        history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        setupHashListener<span class="token punctuation">,</span>
        setupHashListener
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        app<span class="token punctuation">.</span>_route <span class="token operator">=</span> route
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="vueå¦‚ä½•ä½¿ç”¨routerçš„">vueå¦‚ä½•ä½¿ç”¨routerçš„</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">install</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterView'</span><span class="token punctuation">,</span>View<span class="token punctuation">)</span>
  Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterLink'</span><span class="token punctuation">,</span>Link<span class="token punctuation">)</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸€ä¸ªå‰ææ¡ä»¶æ˜¯ï¼švnodeæ˜¯é€šè¿‡renderæ¥åˆ›å»ºçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ”¹å˜_routeçš„å€¼ä¼šæ‰§è¡Œrenderå‡½æ•°ï¼ŒRouter-Viewè¿™ä¸ªç»„ä»¶å®šä¹‰äº†è‡ªå·±çš„renderï¼Œçœç•¥äº†å¤§éƒ¨åˆ†ä»£ç </p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// vueæºç render.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue<span class="token operator">:</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  vnode <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_renderProxy<span class="token punctuation">,</span>vm<span class="token punctuation">.</span>$createElement<span class="token punctuation">)</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token comment">// routeræºç view.js</span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span><span class="token punctuation">{</span>props<span class="token punctuation">,</span>children<span class="token punctuation">,</span>parent<span class="token punctuation">,</span>data<span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">const</span> h <span class="token operator">=</span> parent<span class="token punctuation">.</span>$createElement
  <span class="token operator">...</span>
  <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>component<span class="token punctuation">,</span>data<span class="token punctuation">,</span>children<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="æµç¨‹">æµç¨‹</h3> <h4 id="hashhistory">hashHistory</h4> <div class="language-js extra-class"><pre class="language-js"><code>$router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> HashHistory<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> History<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> History<span class="token punctuation">.</span><span class="token function">updateRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>app<span class="token punctuation">.</span>_route <span class="token operator">=</span> route<span class="token punctuation">}</span> <span class="token operator">--</span><span class="token operator">&gt;</span> vm<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code>1.æ”¹å˜hashå¹¶ä¸ä¼šå¼•èµ·é¡µé¢é‡è½½
2.HTTPè¯·æ±‚ä¸åŒ…æ‹¬#ï¼Œæ‰€ä»¥ä½¿ç”¨hashä¸ä¼šå½±å“åˆ°å…¶ä»–åŠŸèƒ½
3.æ”¹å˜#ä¼šæ”¹å˜æµè§ˆå™¨çš„è®¿é—®å†å²
4.window.location.hashå¯ä»¥è¯»å–å“ˆå¸Œå€¼
5.JavaScriptå¯ä»¥é€šè¿‡onhashchangeç›‘å¬åˆ°hashå€¼çš„å˜åŒ–ï¼Œè¿™å°±æ„å‘³ç€å¯ä»¥çŸ¥é“ç”¨æˆ·åœ¨æµè§ˆå™¨æ‰‹åŠ¨æ”¹å˜äº†hashå€¼
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/vue/" class="prev">
        vue åŸç†åˆ†æ
      </a></span> <span class="next"><a href="/mustKnow/">
        vue å¼€å‘å¿…çŸ¥
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1dd2d079.js" defer></script><script src="/assets/js/2.5b5e09f6.js" defer></script><script src="/assets/js/28.cf7f39de.js" defer></script>
  </body>
</html>
